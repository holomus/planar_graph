<script biruni>
page.ctrl(function(scope, model, fi, bUtil, t) {
  var d = _.omit(model, 'divisions'),
      q = _.pick(model, 'divisions');

  function setJob(row) {
    if (!row) return;
    d.job_id = row.job_id;
    d.job_name = row.name;
  }

  function addJob(value) {
    fi.add_job(null, setJob, { name: value });
  }

  function selectJob() {
    fi.select_job(null, setJob, { where: ['state', '=', 'A'] });
  }

  function save(status) {
    if (page.valid(scope.form)) {
      let data = _.omit(d, 'job_name');
      data.status = status;

      page.post(':save', data).then(page.close, page.alert);
    }
  }

  q.divisions = _.chain(model.divisions)
                 .mapRows(['division_id', 'name', 'parent_id', 'enabled'])
                 .each(x => x.disabled = x.enabled == 'N')
                 .value();

  scope.d = d;
  scope.q = q;
});
</script>
<div class="b-toolbar">
  <button type="button" class="btn btn-primary" ng-click="save('W')" b-hotkey="save"><t>save</t></button>
  <button type="button" class="btn btn-default" ng-click="save('D')" b-hotkey="save"><t>save as draft</t></button>
  <button type="button" class="btn btn-default" ng-click="page.close()">{{ page.close.title }}</button>
</div>
<div class="b-content"><form name="form">
  <div class="form-row">
    <div class="col-sm-12">
      <div class="card card-custom card-stretch gutter-b">
        <div class="card-body">
          <div class="form-row mb-4">
            <div class="col-sm-12">
              <label><t>application number</t></label>
              <input class="form-control" ng-model="d.application_number" b-maxlength="50"/>
            </div>
          </div>
          <div class="form-row mb-4">
            <div class="col-sm-12">
              <label><t>division name</t><r/></label>
              <b-tree-select
                origin="q.divisions"
                id-key="division_id"
                label-key="name"
                parent-key="parent_id"
                model="d.division_id"
                required-key/>
            </div>
            <div class="col-sm-12">
              <label><t>job name</t><r/></label>
              <b-input name="jobs"
                       model="d.job_name | name"
                       model-key="d.job_id | job_id"
                       is-add="fi.add_job"
                       on-add="addJob(value)"
                       is-view="fi.select_job"
                       on-view="selectJob()"
                       required-key>
                {{ row.name }}
              </b-input>
            </div>
          </div>
          <div class="form-row mb-4">
            <div class="col-sm-12">
              <label><t>quantity</t><r/></label>
              <input class="form-control" ng-model="d.quantity" b-number precision="4" scale="0" required/>
            </div>
            <div class="col-sm-12">
              <label><t>wage</t></label>
              <input class="form-control" ng-model="d.wage" b-number precision="20" scale="0"/>
            </div>
          </div>
          <div class="form-group">
            <label><t>responsibilities</t></label>
            <textarea class="form-control" rows="3" ng-model="d.responsibilities" b-maxlength="4000"></textarea>
          </div>
          <div class="form-group">
            <label><t>requirements</t></label>
            <textarea class="form-control" rows="3" ng-model="d.requirements" b-maxlength="4000"></textarea>
          </div>
          <div class="form-group">
            <label><t>note</t></label>
            <textarea class="form-control" rows="4" ng-model="d.note" b-maxlength="300"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</form></div>
