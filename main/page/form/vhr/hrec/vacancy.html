<script biruni>
page.ctrl(function(scope, model, xparam, fi, $timeout, t) {
  var d = _.omit(model, 'references'),
      q = model.references,
      p = {};

  // job
  function setJob(row) {
    if (!row) return;
    d.job_id = row.job_id;
    d.job_name = row.name;
  }

  function selectJob() {
    fi.select_job(null, setJob, { where: ['state', '=', 'A'] });
  }

  function addJob(value) {
    fi.add_job(null, setJob, { name: value });
  }

  // funnel
  function setFunnel(row) {
    if (!row) return;
    d.funnel_id = row.funnel_id;
    d.funnel_name = row.name;
  }

  function selectFunnel() {
    fi.select_funnel(null, setFunnel, { where: ['state', '=', 'A'] });
  }

  function addFunnel(value) {
    fi.add_funnel(null, setFunnel, { name: value });
  }

  // langs
  function addLangRow() {
    d.langs.push({ });
  }

  function removeLangRow(index) {
    d.langs.splice(index, 1);
    if (d.langs.length == 0) addLangRow();
  }

  // vacancy group
  function changeVacancyTypeQuery(query, value, group) {
    query.param({ vacancy_group_id: group.vacancy_group_id }).searchValue(value);
  }

  function prepareSaveData() {
    var data = _.omit(d, ['job_name', 'funnel_name', 'exam_name', 'recriuters', 'langs']);
    data.langs = _.filter(d.langs, (x) => { return x.lang_id && x.lang_level_id });
    data.recruiter_id = _.pluck(d.recriuters, 'user_id');
    data.description = document.getElementById("description").innerText; // For Keep not Html Format
    data.vacancy_groups = [];
    _.each(q.vacancy_groups, x => {
      let group = {};
      group.vacancy_group_id = x.vacancy_group_id;
      group.vacancy_type_ids = [];
      if (x.multiple_select == 'Y') {
        group.vacancy_type_ids = _.pluck(x.types, 'vacancy_type_id');
      } else {
        group.vacancy_type_ids.push(x.vacancy_type_id)
      }

      group.vacancy_type_ids = _.compact(group.vacancy_type_ids);

      data.vacancy_groups.push(group);
    });

    return data;
  }

  function save() {
    q.vacancy_valid = d.recriuters.length > 0;

    if (page.valid(scope.form) && q.vacancy_valid) {
      page.confirm(t('save')(), function() {
        page.post(':save', prepareSaveData()).then(page.close, page.alert);
      });
    }
  }

  function publishHeadHunter() {
    page.confirm(t('save and publish in head hunter?')(), function() {
      var data = prepareSaveData();
      data.billing_type = p.setting.billing_type;
      data.vacancy_type = p.setting.vacancy_type;

      fi.publish_head_hunter(data).then(page.close, page.alert);
    });
  }

  // modal publish Head Hunter
  var modal = page.$content.find('form[name=modal]>.modal');

  function showModal() {
    q.vacancy_valid = d.recriuters.length > 0;
    q.region_valid = d.region_id ? true : false;
    q.description_valid = d.description_in_html.length > 200;

    if (page.valid(scope.form) && q.vacancy_valid && q.region_valid && q.description_valid) {
      p.setting = {
        billing_type: 'standard',
        vacancy_type: 'open'
      };

      $timeout(function() {
        modal.modal('show');
      });
    }
  }

  // modal publish OLX
  var olxModal = page.$content.find('form[name=olxModal]>.modal');

  function showOlxModal() {
    q.olx_title_valid = d.name && d.name.length > 16;
    q.olx_description_valid = d.description_in_html.length > 80 && d.description_in_html.length < 9000;
    q.olx_region_valid = d.region_id ? true : false;
    q.olx_wage_valid = d.wage_from ? true : false;

    if (page.valid(scope.form) && q.olx_region_valid && q.olx_description_valid && q.olx_title_valid && q.olx_wage_valid) {
      p.data = { advertiser_type: 'private' };

      $timeout(function() {
        olxModal.modal('show');
      });
    }
  }

  function setOlxCategory(item, row) {
    if (!row) return;
    item.category_code = row.category_code;
    item.category_name = row.name;

    page.post(':get_attributes', { category_code: item.category_code}).then(res => {
      item.attributes = res.attributes;
      _.each(item.attributes, x => {
        x.values = _.mapRows(x.values, ['code', 'label']);
        x.value_code = x.values[0].code;
      });
    }, page.alert);
  }

  function publishOlx() {
    page.confirm(t('save and publish in olx?')(), function() {
      var data = prepareSaveData();
      data.category_code = p.data.category_code;
      data.advertiser_type = p.data.advertiser_type;
      data.attributes = [];

      _.each(p.data.attributes, x => {
        data.attributes.push({ attribute_code: x.attribute_code, value_code: x.value_code })
      });

      fi.publish_olx(data).then(page.close, page.alert);
    });
  }

  d.recriuters = model.recruiters ? _.mapRows(model.recruiters, ['user_id', 'name']) : [];
  d.langs = model.langs && model.langs.length > 0 ? _.mapRows(model.langs, ['lang_id', 'lang_name', 'lang_level_id', 'lang_level_name']) : [{}];
  q.vacancy_valid = true;
  q.region_valid = true;
  q.description_valid = true;
  q.olx_region_valid = true;
  q.olx_description_valid = true;
  q.olx_title_valid = true;
  q.olx_wage_valid = true;
  q.divisions = _.mapRows(q.divisions, ['division_id', 'name', 'parent_id']);
  q.vacancy_groups = _.mapRows(q.vacancy_groups, ['vacancy_group_id', 'name', 'is_required', 'multiple_select']);
  q.scopes = [
    { kind: 'A', name: t('all')() },
    { kind: 'E', name: t('employee')() },
    { kind: 'N', name: t('non employees')() }
  ];
  q.billing_types = _.mapMatrix(q.billing_types, ['key', 'name']);
  q.vacancy_types = _.mapMatrix(q.vacancy_types, ['key', 'name']);
  q.regions = _.mapRows(q.regions, ['region_id', 'name', 'parent_id']);
  q.olx_advertiser_types = _.mapMatrix(q.olx_advertiser_types, ['key', 'name']);

  if (model.vacancy_id) {
    _.each(q.vacancy_groups, (x) => {
      _.each(model.vacancy_groups, (y) => {
        if (y.vacancy_group_id == x.vacancy_group_id) {
          if (y.multiple_select == 'Y') {
            x.types = _.mapRows(y.types, ['vacancy_type_id', 'name']);
          } else {
            let type = _.mapRows(y.types, ['vacancy_type_id', 'vacancy_type_name'])[0];
            x.vacancy_type_id = type.vacancy_type_id;
            x.vacancy_type_name = type.vacancy_type_name;
          }
        }
      })
    })
  }

  _.extend(d, xparam);

  scope.d = d;
  scope.q = q;
  scope.p = p;
});
</script>
<div class="b-toolbar">
  <button type="button" class="btn btn-primary" ng-click="save()" b-hotkey="save"><t>save</t></button>
  <button type="button" class="btn btn-primary" ng-click="showModal()" ng-if="fi.publish_head_hunter && d.published_head_hunter == 'N'"><t>save and publish in head hunter</t></button>
  <button type="button" class="btn btn-primary" ng-click="showOlxModal()" ng-if="fi.publish_olx && d.published_olx == 'N'"><t>save and publish in olx</t></button>
  <button type="button" class="btn btn-default" ng-click="page.close()">{{ page.close.title }}</button>
</div>
<div class="b-content">
  <form name="form">
    <div class="card card-custom mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-sm-12">
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>opened date</t><r/></label>
                  <input class="form-control" ng-model="d.opened_date" b-date-picker required/>
                </div>
              </div>
              <div class="col-sm-12" ng-if="d.closed_date">
                <div class="form-group">
                  <label><t>closed date</t></label>
                  <span class="form-view">{{ d.closed_date }}</span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label><t>name</t><r/></label>
              <input class="form-control" ng-model="d.name" required/>
              <p class="text-danger" ng-hide="q.olx_title_valid"><t>for publish to OLX, name length must be more than 16 letters</t></p>
            </div>
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>divisions</t><r/></label>
                  <b-tree-select
                    origin="q.divisions"
                    id-key="division_id"
                    label-key="name"
                    parent-key="parent_id"
                    model="d.division_id"
                    required/>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>job</t><r/></label>
                  <b-input name="job"
                           model="d.job_name | name"
                           model-key="d.job_id | job_id"
                           is-add="fi.add_job"
                           on-add="addJob(value)"
                           is-view="fi.select_job"
                           on-view="selectJob()"
                           required-key>
                    {{ row.name }}
                  </b-input>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>funnel</t><r/></label>
                  <b-input name="funnel"
                           model="d.funnel_name | name"
                           model-key="d.funnel_id | funnel_id"
                           is-add="fi.add_funnel"
                           on-add="addFunnel(value)"
                           is-view="fi.select_funnel"
                           on-view="selectFunnel()"
                           required-key>
                    {{ row.name }}
                  </b-input>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>quantity</t><r/></label>
                  <input class="form-control" ng-model="d.quantity" b-number precision="4" scale="0" b-maxlength="4" required/>
                </div>
              </div>
            </div>
            <div class="form-row mb-4">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>region name</t></label>
                  <b-tree-select
                    origin="q.regions"
                    id-key="region_id"
                    model="d.region_id"/>
                  <p class="text-danger" ng-hide="d.region_id || q.region_valid"><t>for publish vacancy region must be selected</t></p>
                  <p class="text-danger" ng-hide="d.region_id || q.olx_region_valid"><t>for publish vacancy to OLX, region must be selected</t></p>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>exam</t></label>
                  <b-input name="exam"
                           model="d.exam_name | name"
                           model-key="d.exam_id | exam_id"
                           is-view="fi.select_exam"
                           on-view="selectExam()">
                    {{ row.name }}
                  </b-input>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label><t>recruiters</t><r/></label>
              <b-input multiple
                       name="recruiter"
                       model="d.recriuters"
                       model-key="user_id"
                       label="name">
                {{ row.name }}
              </b-input>
              <p class="text-danger" ng-hide="d.recriuters.length > 0 || q.vacancy_valid"><t>at least one recruiters must be selected</t></p>
            </div>
            <div class="form-row">
              <div class="col-sm-12">
                <label><t>scope</t></label><br/>
                <label class="radio" ng-repeat="scope in q.scopes">
                  <input type="radio" name="scope" value="{{ scope.kind }}" ng-model="d.scope"/>
                  <span>{{ scope.name }}</span>
                </label>
              </div>
              <div class="col-sm-12">
              <label>&nbsp;</label><br/>
              <label class="checkbox">
                <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.urgent"/>
                <span><t>urgent</t></span>
              </label>
              </div>
            </div>
          </div>
          <div class="col-sm-12">
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>deadline</t></label>
                  <input class="form-control" ng-model="d.deadline" b-date-picker/>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>schedule</t></label>
                  <b-input name="schedule"
                           model="d.schedule_name | name"
                           model-key="d.schedule_id | schedule_id"
                           is-view="fi.select_schedule"
                           on-view="selectSchedule()">
                    {{ row.name }}
                  </b-input>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>wage from</t></label>
                  <input class="form-control" ng-model="d.wage_from" b-number/>
                  <p class="text-danger" ng-hide="d.wage_from || q.olx_wage_valid"><t>for publish to OLX, wage muste be indicated</t></p>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>wage to</t></label>
                  <input class="form-control" ng-model="d.wage_to" b-number/>
                  <p class="text-danger" ng-hide="d.wage_to || q.olx_wage_valid"><t>for publish to OLX, wage muste be indicated</t></p>
                </div>
              </div>
            </div>
            <div class="form-row">
              <label class="col-sm-12"><t>language</t></label>
              <label class="col-sm-12"><t>language level</t></label>
            </div>
            <div class="form-row mb-4" ng-repeat="item in d.langs">
              <div class="col-12">
                <b-input name="langs"
                         model="item.lang_name | name"
                         model-key="item.lang_id | lang_id"
                         is-view="fi.select_lang"
                         on-view="selectLang(item)"
                         required-key="item.lang_level_id">
                  {{ row.name }}
                </b-input>
              </div>
              <div class="col-10">
                <b-input name="lang_levels"
                         model="item.lang_level_name | name"
                         model-key="item.lang_level_id | lang_level_id"
                         label="lang_level_name"
                         is-view="fi.select_lang_level"
                         on-view="selectLangLevel(item)"
                         required-key="item.lang_id">
                  {{ row.name }}
                </b-input>
              </div>
              <div class="col-2 align-self-end">
                <button type="button" class="btn btn-default btn-icon btn-hover-text-danger" ng-click="removeLangRow($index)" ng-if="item.lang_id || d.langs.length > 1">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="btn-group text-center mb-4">
              <button type="button" class="btn btn-default btn-icon" ng-click="addLangRow()">
                <i class="fa fa-plus"></i>
              </button>
            </div>
            <div class="form-group">
              <label><t>description</t></label>
              <b-editor id="description" model="d.description_in_html" rows="4"/>
            </div>
            <p class="text-danger" ng-hide="q.description_valid"><t>for publish responsibility or requirement or note must be write and all text length must be more than 200 letters</t></p>
            <p class="text-danger" ng-hide="q.olx_description_valid"><t>for publish to OLX, responsibility or requirement or note must be write and all text length must be more than 80 letters and less than 9000 letters</t></p>
          </div>
        </div>
      </div>
    </div>
    <div class="card card-custom">
      <div class="card-header">
        <div class="card-title">
          <h3 class="card-label"><t>characteristics</t></h3>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-sm-12 mb-4" ng-repeat="group in q.vacancy_groups track by $index">
            <label>{{ group.name }}<r ng-if="group.is_required == 'Y'"></label>
            <b-input multiple
                     name="vacancy_types"
                     model="group.types"
                     model-key="vacancy_type_id"
                     label="name"
                     on-change="changeVacancyTypeQuery(query, value, group)"
                     ng-if="group.multiple_select == 'Y'"
                     required="group.is_required == 'Y'">
              {{ row.name }}
            </b-input>
            <b-input name="vacancy_types"
                     model="group.vacancy_type_name | name"
                     model-key="group.vacancy_type_id | vacancy_type_id"
                     is-view="fi.select_vacancy_type"
                     on-view="selectVacancyType(group)"
                     on-change="changeVacancyTypeQuery(query, value, group)"
                     ng-if="group.multiple_select == 'N'"
                     required="group.is_required == 'Y'">
              {{ row.name }}
            </b-input>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modal">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"><t>settings</t></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group mb-4">
              <label><t>billing type</t></label>
              <div class="form-row mb-4">
                <div class="col-sm-12" ng-repeat="billing in q.billing_types">
                  <label class="radio">
                    <input type="radio" name="billing_type" value="{{ billing.key }}" ng-model="p.setting.billing_type"/>
                    <span>{{ billing.name }}</span>
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label><t>vacancy type</t></label>
              <div class="form-row mb-4">
                <div class="col-sm-12" ng-repeat="vacancy in q.vacancy_types">
                  <label class="radio">
                    <input type="radio" name="vacancy_type" value="{{ vacancy.key }}" ng-model="p.setting.vacancy_type"/>
                    <span>{{ vacancy.name }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="publishHeadHunter()"><t>publish</t></button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="olxModal">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"><t>settings</t></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label><t>advertising type</t></label>
              <div class="form-row">
                <div class="col-sm" ng-repeat="item in q.olx_advertiser_types">
                  <label class="radio">
                    <input type="radio" name="{{ item.name }}" value="{{ item.key }}" ng-model="p.data.advertiser_type"/>
                    <span>{{ item.name }}</span>
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group mb-4">
              <label><t>category</t></label>
              <b-input name="olx_category"
                       model="p.data.category_name | name"
                       model-key="p.data.category_code | category_code"
                       on-select="setOlxCategory(p.data, row)"
                       required-key>
                {{ row.name }}
              </b-input>
            </div>
            <div class="form-group">
              <label ng-if="p.data.category_code"><t>attributes</t></label><br><br>
              <div class="form-group mb-4" ng-repeat="item in p.data.attributes">
                <label>{{ item.label }}<r ng-if="item.is_require == 'Y'"></label>
                <div class="form-row">
                  <div class="col-sm" ng-repeat="value in item.values">
                    <label class="radio">
                      <input type="radio" name="{{ item.code }}" value="{{ value.code }}" ng-model="item.value_code"/>
                      <span ng-if="value.code == '1'"><t>yes</t></span>
                      <span ng-if="value.code == '0'"><t>no</t></span>
                      <span ng-if="!(value.code == '1' || value.code == '0')">{{ value.label }}</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="publishOlx()"><t>publish</t></button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>