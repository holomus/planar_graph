<script biruni>
page.ctrl(function(scope, model, fi, t, $timeout, param, bRequire) {
  bRequire.load('cropper');
  let d = _.omit(model, 'references'), q = model.references, p = {};
  let photoModal = page.$content.find('form[name=photoModal]>.modal');

  function attachEmployee() {
    if (!fi.attach_employee || d.is_detached != 'Y') return;
    page.confirm(t('attach employee $1{person name}?')(d.name), () => {
      fi.attach_employee({ person_id: d.person_id }).then(page.reload, page.alert);
    });
  }

  // photo
  function setPhotoSrc() {
    if (!d.photo_sha) {
      q.photo_src = getDefaultPhotoSrc();
    } else {
      q.photo_src = page.loadImageLarge(d.photo_sha);
    }
  }

  function showPhoto() {
    if (!d.photo_sha) return;
    page.previewFile({
      sha: d.photo_sha,
      name: d.name,
      type: 'image'
    });
  }

  function getDefaultPhotoSrc() {
    var res = d.gender == q.pg_female ? 'fe' : '';
    return 'page/resource/vhr/no_photo_' + res + 'male.png';
  }

  function showPhotoModal() {
    $timeout(() => photoModal.modal('show'));
  }

  function hidePhotoModal() {
    $timeout(() => photoModal.modal('hide'));
    destroyCropper();
    p.photo = null;
  }

  function savePhoto(photo_sha) {
    fi.save_photo({ person_id: d.person_id, photo_sha: photo_sha })
      .then(result => {
        d.photo_sha = result.photo_sha;
        setPhotoSrc();
        hidePhotoModal();
      }, page.alert);
  }

  function removePhoto() {
    savePhoto(null);
  }

  function destroyCropper() {
    if (p.cropper) {
      p.cropper.destroy();
      photoModal.find('.crop_main_photo').removeAttr('src');
    }
  }

  function uploadPhoto($file) {
    if ($file) {
      p.photo = $file;
      destroyCropper();
    }
    page.dropzone('crop_main_photo').clear();
  }

  function changePhoto() {
    const image = photoModal.find('.crop_main_photo')[0];
    const cropper = new Cropper(image, {
      aspectRatio: 1/1,
      viewMode: 1,
      movable: false,
      guides: false,
      rotatable: false,
      checkOrientation: false,
      zoomable: false,
      background: false,
      center: false,
      ready() {
        $('.cropper-view-box, .cropper-face').css({'border-radius': '50%'});
      }
    });
    p.cropper = cropper;
  }

  function saveCrop() {
    if (p.cropper && p.photo) {
      let file;
      p.cropper.getCroppedCanvas().toBlob(function(blob) {
        file = new File([blob], p.photo.name, {lastModified: Date.now(), type: blob.type});
        d.photo_as_face_rec = p.photo_as_face_rec;
        d.photo_name = p.photo.name;
        savePhoto(file);
      }, p.photo.type);
    } else {
      hidePhotoModal();
    }
  }

  function downloadPhoto() {
    if (!d.photo_sha) return;
    window.open(page.downloadFile(d.photo_sha));
  }

  // passport info
  function passportInfo() {
    changeSection('person_document');

    if (_.contains(q.enabledGrids, 'person_document')) {
      page.subpage('person_document')
          .broadcast('passport_info', { document_id: d.passport_id });
    } else {
      page.subpage('person_document')
          .on('ready', () => page.subpage('person_document').broadcast('passport_info', { document_id: d.passport_id }));
    }
  }

  // change sections
  function changeSection(section) {
    if (!section) return;
    q.activeSection = section;
    if (_.contains(q.enabledGrids, section)) return;

    if (section == 'person_settings') {
      page.subpage(section).run(fi[section].uri, { person_id: d.person_id, employee_id: d.person_id }, { only_person_info: true });
    } else page.subpage(section).run(fi[section].uri, { person_id: d.person_id });

    q.enabledGrids.push(section);

    if (section == 'person_main') {
      page.subpage(section).on('person_change', loadPerson);
    }
    if (section == 'staff_location') {
      page.subpage(section).on('location_change', loadLocation);
    }
  }

  function loadPerson() {
    page.post(':load_person', { person_id: d.person_id }).then(result => {
      _.extend(d, result);
      setPhotoSrc();
    }, page.alert);
  }

  function loadLocation() {
    page.post(':load_location', { person_id: d.person_id })
        .then(result => _.extend(d, result), page.alert);
  }

  // tabs
  function hasMoreTab() {
    return q.more_first_tabs.length > 0 || q.more_second_tabs.length > 0;
  }

  function hasMoreTabSeparator() {
    return q.more_first_tabs.length > 0 && q.more_second_tabs.length > 0;
  }

  function moreTabActive() {
    return _.contains(q.more_tab_names, q.activeSection);
  }

  function fixTabs() {
    let tabs = _.filter(q.all_tabs, x => x.filterFunc());
    q.header_tabs = [];
    q.more_tab_names = [];
    q.more_first_tabs = [];
    q.more_second_tabs = [];
    // first 5 tabs
    for (let i = 0; i < tabs.length && i < 5; i++) {
      q.header_tabs.push(tabs[i]);
    }
    // other tabs
    for (let i = 5; i < tabs.length; i++) {
      let more_second_tab_names = [];
      q.more_tab_names.push(tabs[i].name);
      if (_.contains(more_second_tab_names, tabs[i].name)) {
        q.more_second_tabs.push(tabs[i]);
      } else {
        q.more_first_tabs.push(tabs[i]);
      }
    }
  }

  d.person_id = param.person_id;
  q.all_tabs = _.mapRows([
                ['person_main', () => fi.person_main, 'far fa-address-card'],
                ['staff_location', () => fi.staff_location, 'fas fa-map-marker-alt'],
                ['person_education', () => fi.person_education, 'fas fa-user-graduate'],
                ['person_bank_account', () => fi.person_bank_account, 'fas fa-money-check'],
                ['person_document', () => fi.person_document, 'fas fa-book'],
                ['person_family', () => fi.person_family, 'fas fa-users'],
                ['person_reference', () => fi.person_reference, 'fas fa-clipboard'],
                ['person_work', () => fi.person_work, 'fas fa-briefcase'],
                ['person_inventories', () => fi.person_inventories, 'fas fa-cart-arrow-down'],
                ['person_files', () => fi.person_files, 'far fa-folder-open'],
                ['person_trainings', () => fi.person_trainings, 'fas fa-chalkboard-teacher'],
                ['person_settings', () => fi.person_settings, 'fas fa-user-cog']
              ], ['name', 'filterFunc', 'icon']);
  q.enabledGrids = [];
  q.t_user_edit_image = t('edit image')();

  p.no_photo = 'page/resource/vhr/no_image.png';
  p.photo_as_face_rec = d.photo_as_face_rec;

  setPhotoSrc();
  fixTabs();

  photoModal.find('.crop_main_photo').on('load', () => changePhoto());
  $timeout(() => changeSection('person_main'));

  scope.d = d;
  scope.q = q;
  scope.p = p;
});
</script>
<div class="b-content vhr501">
  <style>
    .vhr501 .img-container {
      /* Never limit the container height here */
      max-width: 100%;
    }
    .vhr501 .img-container img {
      /* This is important */
      width: 100%;
    }
    .vhr501 .card.card-custom {
      background-color: #ffffff !important;
    }
    .vhr501 .card b-pg-grid .tbl-container {
      box-shadow: none !important;
      border: 1px solid #ecf0f3;
      border-radius: 3px;
    }
    .vhr501 b-pg-grid .tbl .tbl-header .tbl-header-cell,
    .vhr501 b-grid .tbl .tbl-header .tbl-header-cell {
      border-bottom: none !important;
    }
    .vhr501 b-pg-grid .tbl .tbl-row.tbl-no-data-row,
    .vhr501 b-grid .tbl .tbl-row.tbl-no-data-row {
      border-top: 1px solid #eaeaea !important;
    }
  </style>
  <div class="form-row">
    <div class="col-sm-5">
      <div class="card card-custom card-stretch gutter-b">
        <div class="card-body pt-4">
          <div class="d-flex bd-highlight">
            <div class="mr-auto bd-highlight">
              <a class="btn btn-clean btn-hover-light-primary btn-sm btn-icon" ng-click="page.close()"><i class="fas fa-arrow-left"></i></i></a>
            </div>
            <div class="bd-highlight dropdown dropdown-inline" ng-if="fi.save_photo">
              <a class="btn btn-clean btn-hover-light-primary btn-sm btn-icon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-h"></i>
              </a>
              <div class="dropdown-menu dropdown-menu-md dropdown-menu-right" style="cursor: pointer;">
                <!--begin::Navigation-->
                <ul class="navi navi-hover py-5">
                  <li class="navi-item" ng-if="fi.save_photo">
                    <a class="navi-link" ng-click="showPhotoModal()">
                      <span class="navi-icon">
                        <i class="fas fa-camera"></i>
                      </span>
                      <span class="navi-text">
                        <t ng-if="!d.photo_sha">add photo</t>
                        <t ng-if="d.photo_sha">edit photo</t>
                      </span>
                    </a>
                  </li>
                  <li class="navi-item" ng-if="fi.attach_employee && d.is_detached == 'Y'">
                    <a class="navi-link" ng-click="attachEmployee()">
                      <span class="navi-icon">
                        <i class="fas fa-paperclip"></i>
                      </span>
                      <span class="navi-text">
                        <t>attach employee</t>
                      </span>
                    </a>
                  </li>
                </ul>
                <!--end::Navigation-->
              </div>
            </div>
          </div>
          <div class="mx-auto d-block dropdown w-xxl-225px h-xxl-225px w-xl-200px h-xl-200px w-lg-150px h-lg-150px w-md-100px h-md-100px w-sm-75px h-sm-75px text-center" title="{{ q.t_user_edit_image }}">
            <div class="image-input image-input-outline" style="border-radius: 50%;">
              <div class="image-input-wrapper h-200px w-200px w-xxl-225px h-xxl-225px w-xl-200px h-xl-200px w-lg-150px h-lg-150px w-md-100px h-md-100px w-sm-75px h-sm-75px" style="border-radius: inherit !important;">
                <img class="cursor-pointer mw-100 mh-100" style="border-radius: inherit !important; width: 225px; height: 225px; object-fit: cover;" ngf-src="q.photo_src" ng-click="d.photo_sha ? showPhoto() : fi.save_photo ? showPhotoModal() : null">
              </div>
            </div>
          </div>
          <div class="d-flex align-items-center justify-content-center mt-2">
            <h5 class="text-center font-weight-bolder">{{ d.name }}</h5>
          </div>

          <div class="d-flex align-items-center mb-3">
            <div class="symbol symbol-30 symbol-light-primary mr-5">
              <span class="symbol-label">
                <i class="fas fa-passport"></i>
              </span>
            </div>
            <div class="d-flex flex-column font-weight-bold">
              <span class="text-muted"><t>pasport_series and number</t></span>
              <span class="mb-1 font-size-lg" ng-class="{ 'cursor-pointer text-hover-primary' : fi.person_document }" ng-click="fi.person_document ? passportInfo() : null">{{ d.passport_series + ' ' + d.passport_number }}</span>
              <span class="mb-1 font-size-sm" ng-show="!d.passport_series">&mdash;</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3" ng-show="d.main_phone">
            <div class="symbol symbol-30 symbol-light-primary mr-5">
              <span class="symbol-label">
                <i class="fas fa-phone-alt"></i>
              </span>
            </div>
            <div class="d-flex flex-column font-weight-bold">
              <span class="text-muted"><t>phone number</t></span>
              <span class="mb-1 font-size-lg">{{ d.main_phone }}</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3" ng-show="d.email">
            <div class="symbol symbol-30 symbol-light-primary mr-5">
              <span class="symbol-label">
                <i class="far fa-envelope"></i>
              </span>
            </div>
            <div class="d-flex flex-column font-weight-bold">
              <span class="text-muted"><t>email</t></span>
              <span class="mb-1 font-size-lg" style="word-break: break-all">{{ d.email }}</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3" ng-show="d.location_count > 0">
            <div class="symbol symbol-30 symbol-light-primary mr-5">
              <span class="symbol-label">
                <i class="fas fa-map-marker-alt"></i>
              </span>
            </div>
            <div class="d-flex flex-column font-weight-bold">
              <span class="text-muted"><t>location</t></span>
              <span ng-if="d.location_count <= 3" class="mb-1 font-size-lg">{{ d.location_names }}</span>
              <span ng-if="d.location_count > 3" class="mb-1 font-size-lg" ng-class="{ 'cursor-pointer text-hover-primary' : fi.staff_location }" ng-click="fi.staff_location ? changeSection('staff_location') : null">{{ d.location_names }} ...</span>
              <span class="mb-1 font-size-sm" ng-show="!d.location_names">&mdash;</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-19">
      <div class="card card-custom gutter-b">
        <div class="card-header card-header-tabs-line">
          <div class="card-title">
            <ul class="nav nav-tabs nav-tabs-space-lg nav-tabs-line nav-tabs-bold nav-tabs-line-3x" role="tablist">
              <li class="nav-item mr-4" ng-if="tab.filterFunc()" ng-repeat="tab in q.header_tabs">
                <a class="nav-link ml-0" ng-class="{ 'active': q.activeSection == tab.name }" ng-click="changeSection(tab.name)">
                  <span class="nav-icon mr-2">
                    <span class="svg-icon mr-3">
                      <i class="{{ tab.icon }}"></i>
                    </span>
                  </span>
                  <span class="nav-text font-weight-bold">{{ fi[tab.name].title }}</span>
                </a>
              </li>
              <li class="nav-item dropdown" ng-if="hasMoreTab()">
                <a class="nav-link ml-0 dropdown-toggle" ng-class="{ 'active': moreTabActive() }" data-toggle="dropdown" role="button" aria-expanded="false">
                  <span class="nav-icon mr-2">
                    <span class="svg-icon mr-3">
                      <i class="fas fa-bars"></i>
                    </span>
                  </span>
                  <span class="nav-text font-weight-bold"><t>more</t></span>
                </a>
                <div class="dropdown-menu dropdown-menu-md" style="cursor: pointer;">
                  <ul class="navi navi-hover py-5">
                    <li class="navi-item" ng-if="tab.filterFunc()" ng-repeat="tab in q.more_first_tabs">
                      <a class="navi-link" ng-class="{ 'active': q.activeSection == tab.name }" ng-click="changeSection(tab.name)">
                        <span class="navi-icon">
                          <i class="{{ tab.icon }}"></i>
                        </span>
                        <span class="navi-text">{{ fi[tab.name].title }}</span>
                      </a>
                    </li>
                    <li class="navi-separator my-3" ng-if="hasMoreTabSeparator()"></li>
                    <li class="navi-item" ng-if="tab.filterFunc()" ng-repeat="tab in q.more_second_tabs">
                      <a class="navi-link" ng-class="{ 'active': q.activeSection == tab.name }" ng-click="changeSection(tab.name)">
                        <span class="navi-icon">
                          <i class="{{ tab.icon }}"></i>
                        </span>
                        <span class="navi-text">{{ fi[tab.name].title }}</span>
                      </a>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="flex-row-fluid" ng-if="fi.person_main" ng-show="q.activeSection == 'person_main'"><b-subpage name="person_main"/></div>
      <div class="flex-row-fluid" ng-if="fi.staff_location" ng-show="q.activeSection == 'staff_location'"><b-subpage name="staff_location"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_education" ng-show="q.activeSection == 'person_education'"><b-subpage name="person_education"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_bank_account" ng-show="q.activeSection == 'person_bank_account'"><b-subpage name="person_bank_account"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_document" ng-show="q.activeSection == 'person_document'"><b-subpage name="person_document"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_family" ng-show="q.activeSection == 'person_family'"><b-subpage name="person_family"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_reference" ng-show="q.activeSection == 'person_reference'"><b-subpage name="person_reference"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_work" ng-show="q.activeSection == 'person_work'"><b-subpage name="person_work"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_inventories" ng-show="q.activeSection == 'person_inventories'"><b-subpage name="person_inventories"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_files" ng-show="q.activeSection == 'person_files'"><b-subpage name="person_files"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_trainings" ng-show="q.activeSection == 'person_trainings'"><b-subpage name="person_trainings"/></div>
      <div class="flex-row-fluid" ng-if="fi.person_settings" ng-show="q.activeSection == 'person_settings'"><b-subpage name="person_settings"/></div>
    </div>
  </div>

  <form name="photoModal">
    <div class="modal fade" tabindex="-1" role="dialog" data-backdrop="static">
      <div class="modal-dialog" ngf-drop="uploadPhoto($file)" ngf-drag-over-class="'b-drag-over'">
        <div class="modal-content">
          <div class="modal-body">
            <img style="width: 100%;" ngf-src="p.no_photo" ng-show="!p.photo"/>
            <!-- DO NOT PLACE ANYTHING ELSE INSIDE img-container -->
            <div class="img-container">
              <img class="crop_main_photo" ngf-src="p.photo" ng-show="p.photo"/>
            </div>
            <div class="mt-4 mb-4">
              <b-dropzone name="crop_main_photo" on-select="uploadPhoto($file)" accept="'.png,.jpg,.jpeg'"></b-dropzone>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-sm btn-primary" ng-if="fi.save_photo" ng-disabled="!p.photo" ng-click="saveCrop()"><t>save photo</t></button>
            <button type="button" class="btn btn-sm btn-danger" ng-if="d.photo_sha && fi.save_photo" ng-click="removePhoto()"><t>delete</t></button>
            <button type="button" class="btn btn-sm btn-default" ng-click="hidePhotoModal()"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>