<script biruni>
page.ctrl(function(scope, model, fi, t, $timeout, bHttp) {
  var d = {}, q = _.omit(model, 'robots'), p = {};

  // robot group
  function setRobotGroup(data, row) {
    if (!row) return;
    data.robot_group_id = row.robot_group_id;
    data.robot_group_name = row.name;
  }

  function addRobotGroup(data, value) {
    fi.add_robot_group(null, _.partial(setRobotGroup, data), { name: value });
  }

  function selectRobotGroup(data) {
    fi.select_robot_group(null,  _.partial(setRobotGroup, data));
  }

  // wage scale
  function setWageScale(data, row) {
    if (!row) return;
    data.wage_scale_id = row.wage_scale_id;
    data.wage_scale_name = row.name;
  }

  function addWageScale(data, value) {
    fi.add_wage_scale(null, _.partial(setWageScale, data), { name: value });
  }

  function selectWageScale(data) {
    fi.select_wage_scale(null, _.partial(setWageScale, data));
  }

  // job
  function changeQueryJob(data, query, value) {
    query.param({ division_id: data.division_id }).searchValue(value);
  }

  function setJob(data, row) {
    if (!row) return;
    data.job_id = row.job_id;
    data.job_name = row.name;

    bHttp.unblockOnce();
    page.post(':get_hidden_salary_job', { job_id: row.job_id }).then(x => data.hidden_salary_job = x, page.alert);
  }

  function addJob(data, value) {
    fi.add_job(null, _.partial(setJob, data), { name: value, division_ids: [data.division_id] });
  }

  function selectJob(data) {
    fi.select_job({ division_id: data.division_id }, _.partial(setJob, data), { where: ['state', '=', 'A'] });
  }

  function getOrgUnits(data) {
    if (data.division_id && q.old_division != data.division_id) {
      bHttp.unblockOnce();
      page.post(':get_org_units', { division_id: data.division_id }).then(result => {
        q.org_units = _.mapRows(result.org_units, ['org_unit_id', 'name', 'parent_id']);
        q.old_division = data.division_id;
      }, page.alert);
    }
  }

  function changeDivision(data) {
    data.inited ? setJob(data, {}) : data.inited = !data.inited;
    data.org_unit_id = null;

    getOrgUnits(data);
  }

  // rank
  function setRank(data, row) {
    if (!row) return;
    data.rank_id = row.rank_id;
    data.rank_name = row.name;
  }

  function addRank(data, value) {
    fi.add_rank(null, _.partial(setRank, data), { name: value });
  }

  function selectRank(data) {
    fi.select_rank(null,  _.partial(setRank, data));
  }

  // schedule
  function setSchedule(data, row) {
    if (!row) return;
    data.schedule_id = row.schedule_id;
    data.schedule_name = row.name;
  }

  function addSchedule(data, value) {
    fi.add_schedule(null, _.partial(setSchedule, data), { name: value });
  }

  function selectSchedule(data) {
    fi.select_schedule(null,  _.partial(setSchedule, data));
  }

  // labor function
  function setLaborFunction(data, row) {
    if (!row) return;
    data.labor_function_id = row.labor_function_id;
    data.labor_function_name = row.name;
  }

  function addLaborFunction(data, value) {
    fi.add_labor_function(null, _.partial(setLaborFunction, data), { name: value });
  }

  function selectLaborFunction(data) {
    fi.select_labor_function(null,  _.partial(setLaborFunction, data));
  }

  // oper type
  function addOperTypeItem(data) {
    data.oper_types.push({});
  }

  function deleteOperTypeItem(data, item) {
    let index = _.indexOf(data.oper_types, item);
    data.oper_types.splice(index, 1);
  }

  function whereOperType(data) {
    let oper_type_ids = _.chain(data.oper_types).pluck('oper_type_id').compact().value() || [];

    if (!_.isEmpty(oper_type_ids)) {
      return ['oper_type_id', '<>', oper_type_ids];
    } else return null;
  }

  function changeOperTypeQuery(data, query, value) {
    query.where(whereOperType(data)).searchValue(value);
  }

  function setOperType(data, item, row) {
    if (!row) return;
    item.oper_type_id = row.oper_type_id;
    item.oper_type_name = row.name;
    item.indicator_ids = [];

    if (item.oper_type_id) {
      page.post(':get_indicators', _.pick(item, 'oper_type_id')).then((result) => {
        result = _.mapRows(result, ['indicator_id', 'name']);
        _.each(result, indicator => {
          data.indicators[indicator.indicator_id] = data.indicators[indicator.indicator_id] || indicator;
        });
        item.indicator_ids = _.pluck(result, 'indicator_id');
      }, page.alert);
    }
  }

  function addOperType(data, item, value) {
    fi.add_oper_type(null, _.partial(setOperType, data, item), { name: value });
  }

  function selectOperType(data, item) {
    fi.select_oper_type(null,  _.partial(setOperType, data, item));
  }

  // ------------------------------ robot modal ------------------------------//
  var modal = page.$content.find('form[name=modal]>.modal');

  function showModal() {
    $timeout(function() {
      modal.modal('show');
    });
  }

  function hideModal() {
    modal.modal('hide');
  }

  function robotModal(row) {
    let index = _.findIndex(d.attached_robots, row);
    p.data = _.extend(angular.copy(row), { index: index });
    p.active_tab = 'accrual';
    q.old_division = p.data.division_id; 
    
    getOrgUnits(p.data);
    
    page.untouch(scope.modal);
    showModal();
  }

  function saveRobot() {
    if (page.valid(scope.modal)) {
      p.data.is_valid = 'Y';
      d.attached_robots.splice(p.data.index, 1, angular.copy(p.data));

      hideModal();
    }
  }

  // attach robot
  function attachRobot(row) {
    let index = _.findIndex(d.detached_robots, row);
    d.detached_robots.splice(index, 1);

    d.attached_robots.push(row);
  }

  // detach robot
  function detachRobot(row) {
    let index = _.findIndex(d.attached_robots, row);
    d.attached_robots.splice(index, 1);

    d.detached_robots.push(row);
  }

  // save
  function save() {
    let not_valid = _.chain(d.attached_robots).pluck('is_valid').any(x => x == 'N').value();

    if (not_valid) {
      page.alert(t('attached robots contains robots that have unspecified required data')());
    } else {
      page.confirm(t('save?')(), function() {
        var data = {};
        data.robots = _.chain(angular.copy(d.attached_robots))
                        .each(x => {
                          let indicators = [];
                          _.chain(x.oper_types).pluck('indicator_ids').flatten().compact().unique().each(id => indicators.push(x.indicators[id]));
                          x.indicators = indicators;
                        })
                        .map(x => x = _.pick(x, 'robot_id', 'name', 'code', 'robot_group_id', 'division_id', 'org_unit_id', 'job_id', 'state',
                                                'opened_date', 'closed_date', 'schedule_id', 'rank_id', 'labor_function_id', 'description',
                                                'robot_condition', 'wage_scale_id', 'contractual_wage', 'indicators', 'oper_types'))
                        .value();

        page.post(':save', data).then(page.close, page.alert);
      });
    }
  }

  function changeTab(data, tab) {
    data.active_tab = tab;
  }

  function pageId(key) {
    return key + page.id();
  }

  d.attached_robots = [];
  d.detached_robots = _.chain(model.robots)
                       .mapRows(['robot_id', 'name', 'code', 'robot_group_id', 'robot_group_name', 'division_id', 'job_id', 'job_name', 'state', 'opened_date', 'contractual_wage', 'is_valid'])
                       .each(x => {
                         x.indicators = {};
                         x.oper_types = [];
                       })
                       .value();
  q.divisions = _.mapRows(model.divisions, ['division_id', 'name', 'parent_id']);
  q.active_tab = 'attached_robots';

  scope.d = d;
  scope.q = q;
  scope.p = p;
});
</script>
<div class="b-toolbar">
  <button type="button" class="btn btn-primary" ng-click="save()"><t>save</t></button>
  <button type="button" class="btn btn-default" ng-click="page.close()">{{ page.close.title }}</button>
</div>
<div class="b-content">
  <form name="form">
    <div class="card card-custom gutter-b">
      <div class="card-body">
        <ul class="nav nav-tabs nav-tabs-line" role="tablist">
          <li class="nav-item">
            <a data-target="{{ pageId('#attached_robots') }}" class="nav-link" data-toggle="tab" role="tab" ng-class="{ 'active': q.active_tab == 'attached_robots' }" ng-click="changeTab(q, 'attached_robots')">
              <span><t>attached robots</t></span>
            </a>
          </li>
          <li class="nav-item">
            <a data-target="{{ pageId('#detached_robots') }}" class="nav-link" data-toggle="tab" role="tab" ng-class="{ 'active': q.active_tab == 'detached_robots' }" ng-click="changeTab(q, 'detached_robots')">
              <span><t>detached robots</t></span>
            </a>
          </li>
        </ul>
        <div class="tab-content mt-4">
          <div class="tab-pane" id="{{ pageId('attached_robots') }}" ng-class="{ 'active': q.active_tab == 'attached_robots' }" role="tabpanel">
            <div class="row mb-2">
              <div class="offset-sm-14 col-sm-10">
                <b-pg-controller name="attached_robots"/>
              </div>
            </div>
            <b-pg-grid name="attached_robots" local-data="d.attached_robots" search="name, code, robot_group_name, job_name" current-limit="1000" searchable="robot_id">
              <b-pg-row>
                <b-pg-col name="robot_id" size="2"/>
                <b-pg-col name="name" size="3"/>
                <b-pg-col name="code" size="3"/>
                <b-pg-col name="robot_group_name" size="4"/>
                <b-pg-col name="job_name" size="4"/>
                <b-pg-col name="state_name" size="3">
                  <div class="alert alert-custom text-center py-1 px-3 m-0" ng-class="{ 'alert-light-success': row.state == 'A', 'alert-light-danger': row.state == 'P' }">
                    <div class="alert-text">
                      <span ng-if="row.state == 'A'"><t>active</t></span>
                      <span ng-if="row.state == 'P'"><t>passive</t></span>
                    </div>
                  </div>
                </b-pg-col>
                <b-pg-col name="is_valid_name" size="3">
                  <div class="alert alert-custom text-center py-1 px-3 m-0" ng-class="{ 'alert-light-success': row.is_valid == 'Y', 'alert-light-danger': row.is_valid == 'N' }">
                    <div class="alert-text">
                      <span ng-if="row.is_valid == 'Y'"><t>row valid</t></span>
                      <span ng-if="row.is_valid == 'N'"><t>row not valid</t></span>
                    </div>
                  </div>
                </b-pg-col>
                <b-pg-col name="actions" size="2">
                  <div class="text-left">
                    <button type="button" class="btn btn-default btn-icon" ng-click="robotModal(row)"><i class="fa fa-edit"></i></button>
                    <button type="button" class="btn btn-default btn-icon btn-hover-text-danger" ng-click="detachRobot(row)"><i class="fa fa-times"></i></button>
                  </div>
                </b-pg-col>
              </b-pg-row>
              <b-pg-extra-col name="opened_date"/>
              <b-pg-extra-col name="closed_date"/>
              <b-pg-extra-col name="schedule_name"/>
              <b-pg-extra-col name="rank_name"/>
              <b-pg-extra-col name="wage_scale_name"/>
            </b-pg-grid>
          </div>
          <div class="tab-pane" id="{{ pageId('detached_robots') }}" ng-class="{ 'active': q.active_tab == 'detached_robots' }" role="tabpanel">
            <div class="row mb-2">
              <div class="offset-sm-14 col-sm-10">
                <b-pg-controller name="detached_robots"/>
              </div>
            </div>
            <b-pg-grid name="detached_robots" local-data="d.detached_robots" search="name, code, robot_group_name, job_name" current-limit="1000" searchable="robot_id">
              <b-pg-row>
                <b-pg-col name="robot_id" size="4"/>
                <b-pg-col name="name" size="4"/>
                <b-pg-col name="code" size="4"/>
                <b-pg-col name="robot_group_name" size="4"/>
                <b-pg-col name="job_name" size="4"/>
                <b-pg-col name="state_name" size="3">
                  <div class="alert alert-custom text-center py-1 px-3 m-0" ng-class="{ 'alert-light-success': row.state == 'A', 'alert-light-danger': row.state == 'P' }">
                    <div class="alert-text">
                      <span ng-if="row.state == 'A'"><t>active</t></span>
                      <span ng-if="row.state == 'P'"><t>passive</t></span>
                    </div>
                  </div>
                </b-pg-col>
                <b-pg-col name="actions" size="1">
                  <div class="text-left">
                    <button type="button" class="btn btn-default btn-icon btn-hover-text-success" ng-click="attachRobot(row)"><i class="fa fa-check"></i></button>
                  </div>
                </b-pg-col>
              </b-pg-row>
            </b-pg-grid>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modal">
    <div class="modal fade" tabindex="-1" role="robot">
      <div class="modal-dialog modal-xl" role="journal">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"><t>edit robot</t></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>division name</t><r></label>
                  <b-tree-select
                    origin="q.divisions"
                    id-key="division_id"
                    model="p.data.division_id"
                    on-change="changeDivision(p.data)"
                    required/>
                </div>
                <div class="form-group">
                  <label><t>org unit name</t></label>
                  <b-tree-select
                    origin="q.org_units"
                    id-key="org_unit_id"
                    model="p.data.org_unit_id"
                    disabled="!p.data.division_id"/>
                </div>
                <div class="form-group">
                  <label><t>job name</t><r></label>
                  <b-input name="jobs"
                           model="p.data.job_name | name"
                           model-key="p.data.job_id | job_id"
                           on-change="changeQueryJob(p.data, query, value)"
                           on-select="setJob(p.data, row)"
                           on-delete="setJob(p.data, {})"
                           is-add="fi.add_job"
                           is-view="fi.select_job"
                           on-add="addJob(p.data, value)"
                           on-view="selectJob(p.data)"
                           readonly="!p.data.division_id"
                           required-key>
                    {{ row.name }}
                  </b-input>
                </div>
                <div class="form-group">
                  <label><t>rank name</t></label>
                  <b-input name="ranks"
                           model="p.data.rank_name | name"
                           model-key="p.data.rank_id | rank_id"
                           column="order_no"
                           sort="order_no, name"
                           is-add="fi.add_rank"
                           is-view="fi.select_rank"
                           on-add="addRank(p.data, value)"
                           on-view="selectRank(p.data)">
                    {{ row.name }}
                  </b-input>
                </div>
                <div class="form-group">
                  <label><t>name</t><r/></label>
                  <input type="text" class="form-control" ng-model="p.data.name" b-maxlength="200" readonly required/>
                </div>
                <div class="form-group row">
                  <div class="col-sm-12">
                    <label><t>state</t></label><br>
                    <label class="switch">
                      <input type="checkbox" ng-true-value="'A'" ng-false-value="'P'" ng-model="p.data.state"/>
                      <span>
                        <t ng-if="p.data.state == 'A'">active</t>
                        <t ng-if="p.data.state == 'P'">passive</t>
                      </span>
                    </label>
                  </div>
                  <div class="col-sm-12">
                    <label>&nbsp;</label><br>
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="p.data.contractual_wage" ng-disabled="q.access_hidden_salary == 'N' && p.data.hidden_salary_job == 'Y'"/>
                      <span><t>contractual wage</t></span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-row">
                  <div class="col-sm-12 mb-4">
                    <label><t>opened date</t><r/></label>
                    <input type="text" class="form-control" ng-model="p.data.opened_date" ng-blur="setWageScale(p.data, {})" b-date-picker required/>
                  </div>
                  <div class="col-sm-12 mb-4">
                    <label><t>closed date</t></label>
                    <input type="text" class="form-control" ng-model="p.data.closed_date" b-date-picker/>
                  </div>
                </div>
                <div class="form-group">
                  <label><t>robot group</t></label>
                  <b-input name="robot_groups"
                           model="p.data.robot_group_name | name"
                           model-key="p.data.robot_group_id | robot_group_id"
                           is-add="fi.add_robot_group"
                           is-view="fi.select_robot_group"
                           on-add="addRobotGroup(p.data, value)"
                           on-view="selectRobotGroup(p.data)">
                      {{ row.name }}
                  </b-input>
                </div>
                <div class="form-group">
                  <label><t>schedule name</t></label>
                  <b-input name="schedules"
                           model="p.data.schedule_name | name"
                           model-key="p.data.schedule_id | schedule_id"
                           is-add="fi.add_schedule"
                           is-view="fi.select_schedule"
                           on-add="addSchedule(p.data, value)"
                           on-view="selectSchedule(p.data)">
                    {{ row.name }}
                  </b-input>
                </div>
                <div class="form-group" ng-if="p.data.contractual_wage == 'N' && (q.access_hidden_salary == 'Y' || p.data.hidden_salary_job != 'Y')">
                  <label><t>wage scale</t><r/></label>
                  <b-input name="wage_scales"
                           model="p.data.wage_scale_name | name"
                           model-key="p.data.wage_scale_id | wage_scale_id"
                           is-add="fi.add_wage_scale"
                           on-add="addWageScale(p.data, value)"
                           is-view="fi.select_wage_scale"
                           on-view="selectWageScale(p.data)"
                           required-key>
                      {{ row.name }}
                  </b-input>
                </div>
                <div class="form-group row">
                  <div class="col-sm-12">
                    <label><t>code</t></label>
                    <input type="text" class="form-control" ng-model="p.data.code" b-maxlength="50"/>
                  </div>
                </div>
              </div>
            </div>
            <ul class="nav nav-tabs nav-tabs-line" role="tablist">
              <li class="nav-item">
                <a data-target="{{ pageId('#accrual') }}" class="nav-link" data-toggle="tab" role="tab" ng-class="{ 'active': p.active_tab == 'accrual' }" ng-click="changeTab(p, 'accrual')">
                  <span><t>accrual</t></span>
                </a>
              </li>
              <li class="nav-item">
                <a data-target="{{ pageId('#extra') }}" class="nav-link" data-toggle="tab" role="tab" ng-class="{ 'active': p.active_tab == 'extra' }" ng-click="changeTab(p, 'extra')">
                  <span><t>extra</t></span>
                </a>
              </li>
            </ul>
            <div class="tab-content mt-4">
              <div class="tab-pane" id="{{ pageId('accrual') }}" ng-class="{ 'active': p.active_tab == 'accrual' }" role="tabpanel">
                <div ng-if="q.access_hidden_salary == 'Y' || p.data.hidden_salary_job != 'Y'">
                  <div class="mb-2">
                    <button type="button" class="btn btn-default" ng-click="addOperTypeItem(p.data)"><t>add</t></button>
                  </div>
                  <b-pg-grid name="oper_types" local-data="p.data.oper_types" iterator="item" current-limit="1000">
                    <b-pg-row>
                      <b-pg-col name="rownum" size="1">
                        <div class="text-center">{{ item.rownum }}</div>
                      </b-pg-col>
                      <b-pg-col name="oper_type" size="10">
                        <b-input name="oper_types"
                                 model="item.oper_type_name | name"
                                 model-key="item.oper_type_id | oper_type_id"
                                 on-change="changeOperTypeQuery(p.data, query, value)"
                                 is-add="fi.add_oper_type"
                                 is-view="fi.select_oper_type"
                                 on-add="addOperType(p.data, item, value)"
                                 on-view="selectOperType(p.data, item)"
                                 on-select="setOperType(p.data, item, row)"
                                 on-delete="setOperType(p.data, item, {})"
                                 required-key>
                          {{ row.name }}
                        </b-input>
                      </b-pg-col>
                      <b-pg-col name="indicators" size="11">
                        <div ng-repeat="id in item.indicator_ids">
                          <div class="form-row">
                            <label class="col-sm-18" ng-class="{ 'mb-2': !$last }">{{ p.data.indicators[id].name }}</label>
                            <div class="col-sm-6" ng-class="{ 'mb-2': !$last }">
                              <input type="text" class="form-control" ng-readonly="p.data.contractual_wage == 'N' && q.wage_indicator_id == p.data.indicators[id].indicator_id" ng-model="p.data.indicators[id].indicator_value" b-number precision="20" scale="6">
                            </div>
                          </div>
                        </div>
                      </b-pg-col>
                      <b-pg-col name="actions" size="2">
                        <div class="text-center">
                          <button type="button" class="btn btn-default btn-icon btn-hover-text-danger" ng-click="deleteOperTypeItem(p.data, item)"><i class="fa fa-trash"></i></button>
                        </div>
                      </b-pg-col>
                    </b-pg-row>
                  </b-pg-grid>
                </div>
                <div ng-if="q.access_hidden_salary == 'N' && p.data.hidden_salary_job == 'Y'">
                  <div class="d-flex justify-content-center" style="width: auto; height: 300px;">
                    <div class="align-self-center">
                      <div class="text-center mb-4">
                        <i style="font-size: 6rem; color: #e0e0e0" class="fas fa-eye-slash"></i>
                        <div class="font-weight-bolder text-center">
                          <h5><t>you don't have access to add or view salaries</t></h5>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="tab-pane" id="{{ pageId('extra') }}" ng-class="{ 'active': p.active_tab == 'extra' }" role="tabpanel">
                <div class="row">
                  <div class="col-sm-12">
                    <div class="form-group">
                      <label><t>labor function name</t></label>
                      <b-input name="labor_functions"
                               model="p.data.labor_function_name | name"
                               model-key="p.data.labor_function_id | labor_function_id"
                               is-add="fi.add_labor_function"
                               is-view="fi.select_labor_function"
                               on-add="addLaborFunction(p.data, value)"
                               on-view="selectLaborFunction(p.data)">
                        {{ row.name }}
                      </b-input>
                    </div>
                    <div class="form-group">
                      <label><t>hiring condition</t></label>
                      <textarea class="form-control" rows="2" ng-model="p.data.hiring_condition" b-maxlength="300"></textarea>
                    </div>
                    <div class="form-group">
                      <label><t>description</t></label>
                      <textarea class="form-control" rows="2" ng-model="p.data.description" b-maxlength="300"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="saveRobot()"><t>save</t></button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>