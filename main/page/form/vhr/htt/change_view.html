<script biruni>
page.init(function() {
  var statusClass = { N: 'warning', A: 'success', D: 'danger', C: 'primary' },
      pg = page.grid('table_change_audit');

  pg.asHtml('status_html', 'status,status_name', row => {
    return `<div class="alert alert-custom alert-light-${ statusClass[row.status] } text-center py-1 px-3 m-0"><div class="alert-text">${ row.status_name }</div></div>`;
  });
  pg.disable();

  page.grid('table_change_days_audit').disable();
});

page.ctrl(function(scope, model, fi, t, $timeout, bUtil) {
  var d = _.omit(model, 'references'),
      q = model.references,
      p = { data: {} },
      modal = page.$content.find("form[name=modal]>.modal");

  function edit() {
    fi.edit({ change_id: d.change_id });
  }

  function doAction(doFunc, doTrans, change_id) {
    page.confirm(doTrans, function() {
      doFunc({ filial_id: d.filial_id, change_id: change_id }).then(page.reload, page.alert);
    });
  }

  function addWeightItem() {
    p.data.weights.push({});
  }

  function removeWeightItem() {
    _.each(p.data.weights_checked.rows(), function(row) {
      let index = _.findIndex(p.data.weights, row);
      p.data.weights.splice(index, 1);
    });
    p.data.weights_checked = {};
  }

  function onCheck(checked) {
    p.data.weights_checked = checked;
  }

  // modal
  var modalWeights = page.$content.find('form[name=modalWeights]>.modal');

  function showModalWeights() {
    $timeout(function() {
      modalWeights.modal('show');
    });
  }

  function hideModalWeights() {
    $timeout(function() {
      modalWeights.modal('hide');
    });
  }

  function editWeights(day) {
    p.title = t('weighted times for $1{change_date}')(day.change_date);

    p.data = _.extend(p.data, day);
    p.data.weights = d.weights[day.change_date] || [];
    p.data.intersected_parts = [];
    p.data.exceed_parts = [];

    showModalWeights();
  }

  function saveWeight() {
    if (page.valid(scope.modalWeights)) {
      var data = _.pick(d, 'staff_id', 'change_id');

      data.change_date = p.data.change_date;
      data.weights = _.map(p.data.weights, x => {
        var y = angular.copy(x);
        y.begin_time = bUtil.timeToMinutes(x.begin_time);
        y.end_time = bUtil.timeToMinutes(x.end_time);

        return y;
      });

      page.post(':save_change_day_weights', data).then(function() {
        d.weights[p.data.change_date] = p.data.weights;

        hideModalWeights();
      }, page.alert);
    }
  }

  function prepAction(doFunc, doTrans, is_modal) {
    return is_modal ? function() {
      p.title = doTrans(d.change_kind_name, d.change_date);
      p.data = { filial_id: d.filial_id, change_id: d.change_id };
      p.action = function() {
        doFunc(p.data).then(page.reload, page.alert);
      };
      p.action_title = doFunc.title;
      $timeout(() => modal.modal('show'));
    } : function() {
      doAction(doFunc, doTrans(d.change_kind_name, d.change_date), d.change_id);
    }
  }

  function queryFetch(section) {
    if (_.contains(q.enabledGrids, section)) return;
    var tableName = 'table_' + section;
    page.query(tableName).param({ change_id: d.change_id });
    page.grid(tableName).fetch();
    page.grid(tableName).enable();

    q.enabledGrids.push(section);
  }

  function changeSection(section) {
    q.activeSection = section;
    if (section == 'audit') queryFetch('change_audit');
    else queryFetch(section);
  }

  function auditDetails(row) {
    fi.audit_details({ change_id: d.change_id, context_id: row.t_context_id });
  }

  function pageId(tab, prefix) {
    return (prefix || '') + tab + page.id();
  }

  function buttonClass(style) {
    return `btn-${ style }`;
  }

  // -------------------- modal trash --------------------- //
  var modalTrash = page.$content.find('form[name=modalTrash]>.modal');

  function showTrashModal() {
    $timeout(function() {
      modalTrash.modal('show');
    });
  }

  function complete(change_id) {
    fi.complete({ change_id: change_id }).then(page.reload, page.alert); 
  }

  function checkComplete() {
    page.confirm(t('complete change $1{change_kind_name} on $2{change_date}?')(d.change_kind_name, d.change_date), function() {
      q.need_weight_size = 0;

      _.each(d.change_dates, x => {
        if (x.day_kind == q.day_kind_work && (_.isUndefined(d.weights[x.change_date]) || d.weights[x.change_date].length == 0))  {
            q.need_weight_size ++;
        }
      })

      if (q.need_weight_size > 0) {
        p.title = t('days without weight were determined on change $1{change_kind_name} on $2{change_date}')(d.change_kind_name, d.change_date);
        p.data = {};
        p.data.change_id = d.change_id;
        p.data.solutions = [
          t('if you do not add weights to change day these days are not considered working days')(),
          t('or just confirm')()
        ];

        showTrashModal();
      } else {
        complete(d.change_id);
      }
    });
  }

  switch (d.status) {
    case q.change_status_new: q.status_class = 'alert-warning'; break;
    case q.change_status_approved: q.status_class = 'alert-success'; break;
    case q.change_status_completed: q.status_class = 'alert-primary'; break;
    case q.change_status_denied: q.status_class = 'alert-danger'; break;
  }
  d.change_dates = _.mapRows(d.change_dates, ['change_date',
                                              'swapped_date',
                                              'day_kind',
                                              'day_kind_name',
                                              'begin_time',
                                              'end_time',
                                              'break_enabled',
                                              'break_begin_time',
                                              'break_end_time',
                                              'plan_time']);

  d.weights =  _.chain(d.weights)
                .mapRows(['change_date', 'begin_time', 'end_time', 'weight'])
                .each(x => {
                  x.begin_time = bUtil.minutesToTime(x.begin_time);
                  x.end_time = bUtil.minutesToTime(x.end_time);
                }) 
                .groupBy('change_date')
                .value();

  q.enabledGrids = ['main'];
  q.activeSection = 'main';

  scope.approve = prepAction(fi.approve, t('approve change $1{change_kind_name} on $2{change_date}?'), true);
  scope.deny = prepAction(fi.deny, t('deny change $1{change_kind_name} on $2{change_date}?'), true);
  scope.cancel = prepAction(fi.cancel, t('cancel change $1{change_kind_name} on $2{change_date}?'));
  scope.reset = prepAction(fi.reset, t('reset change $1{change_kind_name} on $2{change_date}?'));

  let actions = [
    { has_access: fi.approve && d.status == 'N', execute: scope.approve, name: 'approve', class: 'primary' },
    { has_access: fi.deny && d.status == 'N', execute: scope.deny, name: 'deny', class: 'danger' },
    { has_access: fi.complete && d.status == 'A', execute: checkComplete, name: 'complete', class: 'primary' },
    { has_access: fi.cancel && d.status == 'A', execute: scope.cancel, name: 'cancel', class: 'danger' },
    { has_access: fi.reset && d.status != 'N', execute: scope.reset, name: 'reset', class: 'primary' }
  ];

  q.actions = _.chain(actions)
               .reject(x => !x.has_access)
               .each(x => x.title = fi[x.name].title)
               .value();

  if (q.actions.length > 0)
    q.firstAction = q.actions[0];

  scope.q = q;
  scope.d = d;
  scope.p = p;
});
</script>
<div class="b-toolbar">
  <button type="button" class="btn btn-success" ng-click="edit()" ng-if="fi.edit && d.status == q.change_status_new" b-hotkey="edit">{{ fi.edit.title }}</button>
  <button type="button" class="btn" ng-click="q.firstAction.execute()" ng-if="q.actions.length == 1 && q.firstAction.has_access" ng-class="buttonClass(q.firstAction.class)">{{ q.firstAction.title }}</button>
  <div class="btn-group" ng-if="q.actions.length > 1">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><t>change status</t></button>
    <div class="dropdown-menu">
      <a href class="dropdown-item" ng-repeat="action in q.actions" ng-if="action.has_access" ng-click="action.execute()">{{ action.title }}</a>
    </div>
  </div>
  <button type="button" class="btn btn-default" ng-click="page.close()">{{ page.close.title }}</button>
</div>
<div class="b-content">
  <form name="form">
    <div class="form-row">
      <div class="col-lg-5">
        <div class="card card-custom card-stretch gutter-b">
          <div class="card-body">
            <div class="text-center mb-9">
              <div class="b-offcanvas-hide">
                <span class="font-weight-bolder font-size-h3">
                  <t p1="d.staff_name" p2="d.created_on">$1's change by $2</t>
                </span>
                <span class="text-muted">&nbsp;({{ d.change_id }})</span>
              </div>
              <div class="b-offcanvas-hide alert alert-custom text-center py-1 px-5 mb-0 mt-2 d-inline-flex" ng-class="q.status_class">
                <div class="alert-text">{{ d.status_name }}</div>
              </div>
            </div>
            <div class="navi navi-bolder navi-hover navi-active navi-link-rounded">
              <div class="navi-item mb-2">
                <a href class="navi-link py-4" ng-class="{ 'active': q.activeSection == 'main' }" ng-click="changeSection('main')">
                  <span class="navi-icon mr-2">
                    <i class="fa fa-info-circle"></i>
                  </span>
                  <span class="navi-text font-size-lg"><t>main</t></span>
                </a>
              </div>
              <div class="navi-item mb-2">
                <a href class="navi-link py-4" ng-class="{ 'active': q.activeSection == 'audit' }" ng-click="changeSection('audit')" ng-if="fi.audit">
                  <span class="navi-icon mr-2">
                    <i class="fa fa-user-clock"></i>
                  </span>
                  <span class="navi-text font-size-lg"><t>audit</t></span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-19" ng-show="q.activeSection == 'main'">
        <div class="card card-custom card-stretch gutter-b">
          <div class="card-header">
            <div class="card-title">
              <h5 class="font-weight-bolder"><t>main</t></h5>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>staff name</t></label>
                  <span class="form-view">{{ d.staff_name }}</span>
                </div>
                <div class="form-group mb-4" ng-if = d.filial_id>
                  <label><t>filial name</t></label>
                  <span class="form-view">{{ d.filial_name }}</span>
                </div>
                <div class="form-group mb-4">
                  <label><t>manager note</t></label>
                  <span class="form-view">{{ d.manager_note }}</span>
                </div>
                <div class="form-group mb-4">
                  <label><t>completed by</t></label>
                  <span class="form-view">{{ d.completed_by_name }}</span>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>change kind name</t></label>
                  <span class="form-view">{{ d.change_kind_name }}</span>
                </div>
                <div class="form-group mb-4">
                  <label><t>note</t></label>
                  <span class="form-view">{{ d.note }}</span>
                </div>
                <div class="form-group mb-4">
                  <label><t>approved by</t></label>
                  <span class="form-view">{{ d.approved_by_name }}</span>
                </div>
              </div>
            </div>
            <div class="col-sm-10 ml-auto pr-0" ng-if="d.change_dates.length >= 10">
              <b-pg-controller name="change_dates"/>
            </div>
            <b-pg-grid name="change_dates" local_data="d.change_dates" iterator="item">
              <b-pg-row>
                <b-pg-col name="change_date" size="3"/>
                <b-pg-col name="swapped_date" size="3" access="d.change_kind == 'S'"/>
                <b-pg-col name="day_kind_name" size="3"/>
                <b-pg-col name="plan_time" size="3"/>
                <b-pg-col name="begin_time" size="3"/>
                <b-pg-col name="end_time" size="3"/>
                <b-pg-col name="break_begin_time" size="3"/>
                <b-pg-col name="break_end_time" size="3"/>
                <b-pg-col name="action" size="2" access="d.change_kind != 'S'">
                  <div class="text-center" ng-if="true">
                    <button type="button" class="btn btn-default" ng-click="editWeights(item)" ng-if="item.day_kind == q.day_kind_work && d.status != q.change_status_completed"><t>weights</t></button>
                  </div>
                </b-pg-col>
              </b-pg-row>
            </b-pg-grid>
            <div class="separator separator-solid my-6"></div>
            <div class="row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>created by</t></label>
                  <span class="form-view">{{ d.created_by_name }}</span>
                </div>
                <div class="form-group">
                  <label><t>created on</t></label>
                  <span class="form-view">{{ d.created_on }}</span>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>modified by</t></label>
                  <span class="form-view">{{ d.modified_by_name }}</span>
                </div>
                <div class="form-group">
                  <label><t>modified on</t></label>
                  <span class="form-view">{{ d.modified_on }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-19" ng-if="fi.audit" ng-show="q.activeSection == 'audit'">
        <div class="card card-custom card-stretch gutter-b">
          <div class="card-header card-header-tabs-line">
            <div class="card-title align-items-start flex-column">
              <h5 class="font-weight-bolder mb-0 mt-2"><t>audit</t></h5>
            </div>
            <div class="card-toolobar align-items-end">
              <ul class="nav nav-tabs nav-tabs-line">
                <li class="nav-item">
                  <a href class="nav-link py-4 active" data-toggle="tab" data-target="{{ pageId('change_audit', '#') }}">
                    <span class="nav-icon"><i class="fa fa-file-alt"></i></span>
                    <t>changes</t>
                  </a>
                </li>
                <li class="nav-item">
                  <a href class="nav-link py-4" data-toggle="tab" data-target="{{ pageId('change_days_audit', '#') }}" ng-click="queryFetch('change_days_audit')">
                    <span class="nav-icon"><i class="fa fa-file-invoice"></i></span>
                    <t>change days</t>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="card-body mb-4">
            <div class="tab-content" >
              <div class="tab-pane active" role="tabpanel" id="{{ pageId('change_audit') }}">
                <div class="form-group row">
                  <div class="col-24 offset-md-12 col-md-12">
                    <b-grid-controller  name="table_change_audit"/>
                  </div>
                </div>
                <b-grid name="table_change_audit" required="t_context_id,change_id" on-dblclick="auditDetails(row)"
                        sort="-t_timestamp" search="t_user_name,t_event_name,change_kind"
                        extra-columns="t_source_project_name,t_date,t_filial_name,change_id,note,manager_note">
                  <b-row>
                    <b-col name="t_timestamp" size="3"/>
                    <b-col name="t_user_name" size="3"/>
                    <b-col name="t_event_name" size="3"/>
                    <b-col name="change_kind_name" size=6/>
                    <b-col name="status_name" as-html="status_html" size=3/>
                  </b-row>

                  <b-action>
                    <button type="button" class="btn btn-default" ng-click="auditDetails(row)" ng-if="fi.audit_details"><t>details</t></button>
                  </b-action>

                  <b-filter name="t_user_id" decorate-with="t_user_name"/>
                  <b-filter name="t_event" decorate-with="t_event_name"/>
                  <b-filter name="t_filial_id" decorate-with="t_filial_name"/>
                  <b-filter name="t_source_project_code" decorate-with="t_source_project_name"/>
                  <b-filter name="change_kind" decorate-with="change_kind_name"/>
                  <b-filter name="status" decorate-with="status_name"/>
                </b-grid>
              </div>
              <div class="tab-pane" role="tabpanel" id="{{ pageId('change_days_audit') }}">
                <div class="form-group row">
                  <div class="offset-sm-14 col-sm-10">
                    <b-grid-controller name="table_change_days_audit"/>
                  </div>
                </div>
                <b-grid name="table_change_days_audit" required="t_context_id" on-dblclick="auditDetails(row)"
                        sort="-t_timestamp" search="t_user_name, t_event_name, staff_name, change_date"
                        extra-columns="t_source_project_name,t_date,t_filial_name">
                  <b-row>
                    <b-col name="t_timestamp" size="3"/>
                    <b-col name="t_user_name" size="3"/>
                    <b-col name="t_event_name" size="3"/>
                    <b-col name="change_date" size="4"/>
                    <b-col name="staff_name" size="6"/>
                    <b-col name="day_kind_name" size="5"/>
                  </b-row>

                  <b-action>
                    <button type="button" class="btn btn-default" ng-click="auditDetails(row)" ng-if="fi.audit_details"><t>details</t></button>
                  </b-action>

                  <b-filter name="t_date"/>
                  <b-filter name="t_user_id" decorate-with="t_user_name"/>
                  <b-filter name="t_event" decorate-with="t_event_name"/>
                  <b-filter name="t_filial_id" decorate-with="t_filial_name"/>
                  <b-filter name="t_source_project_code" decorate-with="t_source_project_name"/>
                  <b-filter name="staff_id" decorate-with="staff_name"/>
                  <b-filter name="change_date"/>
                </b-grid>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modal">
    <div class="modal fade" data-backdrop="true" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" ng-bind-html="p.title"></h5>
            <button type="button" class="close" data-dismiss="modal"><i aria-hidden="true" class="fa fa-time"></i></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label><t>manager note</t></label>
              <textarea class="form-control" rows=3 ng-model="p.data.manager_note"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="p.action()">{{ p.action_title }}</button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modalWeights">
    <div class="modal fade" data-backdrop="true" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" ng-bind-html="p.title"></h5>
            <button type="button" class="close" data-dismiss="modal"><i aria-hidden="true" class="fa fa-time"></i></button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>day kind</t></label>
                  <span class="form-view">{{ p.data.day_kind_name }}</span>
                </div>
                <div class="form-group">
                  <label><t>begin time</t></label>
                  <span class="form-view">{{ p.data.begin_time }}</span>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>plan time</t></label>
                  <span class="form-view">{{ p.data.plan_time }}</span>
                </div>
                <div class="form-group">
                  <label><t>end time</t></label>
                  <span class="form-view">{{ p.data.end_time }}</span>
                </div>
              </div>
            </div>
            <div class="form-row" ng-if="p.data.break_enabled">
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>break begin time</t></label>
                  <span class="form-view">{{ p.data.break_begin_time }}</span>
                </div>
              </div>
              <div class="col-sm-12">
                <div class="form-group">
                  <label><t>break end time</t></label>
                  <span class="form-view">{{ p.data.break_end_time }}</span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="col-sm-14 mb-2">
                <button type="button" class="btn btn-default" ng-click="addWeightItem()"><t>add</t></button>
                <button type="button" class="btn btn-danger" ng-click="removeWeightItem()" ng-show="p.data.weights_checked.has">
                  <t p1="p.data.weights_checked.size">delete $1</t>
                </button>
              </div>
              <div class="col-sm-10 mb-2" ng-if="p.data.weights.length > 10">
                <b-pg-controller name="day_weights"/>
              </div>
            </div>
            <div class="form-group">
              <span class="text-muted"><t>time not covered by weights will not be calculated</t></span>
            </div>
            <b-pg-grid name="day_weights" local-data="p.data.weights" iterator="item" on-check="onCheck(checked)" limit="50" min-width="500">
              <b-pg-header name="begin_time"><t>weight begin time</t></b-pg-header>
              <b-pg-header name="end_time"><t>weight end time</t></b-pg-header>
              <b-pg-header name="weight"><t>weight</t></b-pg-header>
              <b-pg-row>
                <b-pg-col name="rownum" size="1"></b-pg-col>
                <b-pg-col name="begin_time" size="8">
                  <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                </b-pg-col>
                <b-pg-col name="end_time" size="8">
                  <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                </b-pg-col>
                <b-pg-col name="weight" size="6">
                  <input type="text" class="form-control" ng-model="item.weight" required b-number scale="0"/>
                </b-pg-col>
              </b-pg-row>
            </b-pg-grid>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="saveWeight()"><t>save</t></button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modalTrash">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="journal">
        <div class="modal-content">
          <div class="modal-header">
            <div class="row">
              <div class="col-sm-2 mt-auto mb-auto"><i class="fas fa-exclamation-triangle fa-2x text-warning"></i></div>
              <div class="col-sm-22 h4 mt-2">{{ p.title }}</div>
            </div>
          </div>
          <div ></div>
          <div class="modal-body">
            <ul ng-repeat="message in p.data.solutions">
              <li>{{ message }}</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" ng-click="complete(p.data.change_id)"><t>confirm</t></button>
            <button type="button" class="btn btn-default" data-dismiss="modal"><t>reject</t></button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>