<script biruni>
page.ctrl(function(scope, model, param, xparam, fi, t, bUtil, $timeout) {
  var d = _.isUndefined(model.schedule_id) ? _.chain(model)
                                              .omit('references')
                                              .extend(xparam)
                                              .value()
                                            : model,
      q = model.references,
      p = {},
      oneDay = 1000 * 60 * 60 * 24,
      t_rest_day = t('R')(),
      t_additional_rest_day = t('AR')();  // Additional rest day


  d.template_id = param.template_id;

  // utility functions
  function pF(val) {
    return parseFloat(parseFloat(val || 0).toFixed(1));
  }

  function str2(val) {
    return val < 10 ? '0' + val: val;
  }

  function timeToSeconds(time) {
    if (time === undefined || time === null) return null;
    time = String(time);
    [minute, second] = time.split(':');
    if (second === undefined) return null;
    return parseInt(minute) * 60 + parseInt(second);
  }

  function secondsToTime(seconds) {
    seconds = parseInt(seconds);
    if (isNaN(seconds)) return null;
    return [str2(parseInt(seconds / 60)), str2(seconds % 60)].join(':');
  }

  function isLeapYear(year) {
    return year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0);
  }

  function dayCountInYear(year) {
    return isLeapYear(year) ? 366 : 365;
  }

  function daysInMonth(month_ind, year) {
    return moment({ year: year, month: month_ind}).daysInMonth();
  }

  function dayIndex(date) {
    return  date.format('DDD') - 1;
  }

  // day color
  function fixDayView(day) {
    day.day_view = t_rest_day;

    if (day.calendar_day_kind == 'H') {
      day.day_color = '#A1E1DC';
      day.text_color = '#1C8531';
    } else if (day.calendar_day_kind == 'A') {
      day.day_view = t_additional_rest_day;
      day.day_color = '#fed4ff';
      day.text_color = '#1C8531';
    } else if (day.calendar_day_kind == 'N') {
      day.day_color = '#FAE078';
      day.text_color = '#BD9700';

      if (day.day_kind == 'W') day.day_view = day.plan_time_view;
    } else if (day.calendar_day_kind == 'S') {
      day.day_color = '#A9DCF8';
      day.text_color = '#006DCC';
      day.swapped_day.day_color = '#A9DCF8';
      day.swapped_day.text_color = '#006DCC';

      if (day.day_kind == 'R') {
        day.day_view = day.swapped_day.plan_time_view;
        day.swapped_day.day_view = t_rest_day;
      } else {
        day.swapped_day.day_view = day.plan_time_view;
      }
    } else if (day.day_kind == 'W') {
      day.day_color =  '';
      day.day_view = day.plan_time_view;
    } else day.day_color =  '#FFC7CE';
  }

  // calendar
  function fixDay(day, cday) {
    let data = _.pick(cday, 'calendar_day_kind', 'day_name');

    if (d.use_calendar != 'Y') data = {};
    else if (cday.calendar_day_kind == 'H' && d.take_holidays != 'Y') data = {}; // holiday
    else if (cday.calendar_day_kind == 'A' && d.take_additional_rest_days != 'Y') data = {}; // additional rest day
    else if (cday.calendar_day_kind == 'N' && d.take_nonworking != 'Y') data = {}; // nonworking
    else if (cday.calendar_day_kind == 'S') {
      if (cday.day.day_kind == cday.day.swapped_day.day_kind) data = {}; // swapped
    }

    day.calendar_day_kind = data.calendar_day_kind;
    day.day_name = data.day_name;
    fixDayView(day);

    if (day.swapped_day) {
      day.swapped_day.calendar_day_kind = data.calendar_day_kind;
      day.swapped_day.day_name = data.day_name;
      fixDayView(day.swapped_day);
    }
  }

  function calcCalendarMonths() {
    _.each(q.calendar_months, calcAvgDayAndHours);
  }

  function clearCalendarDays() {
    _.each(q.calendar_days, cday => fixDay(cday.day, {}));
    calcCalendarMonths();
  }

  function fixCalendarDays() {
    _.each(q.calendar_days, cday => fixDay(cday.day, cday));
    calcCalendarMonths();
  }

  function loadCalendarDays() {
    clearCalendarDays();
    if (!d.year || !d.calendar_id) return;

    page.post(':get_calendar_days', _.pick(d, 'year', 'calendar_id', 'schedule_id')).then(function(result) {
      q.calendar_days = _.mapRows(result.calendar_days, ['calendar_date', 'day_name', 'calendar_day_kind', 'swapped_date']);
      q.calendar_months = [];
      q.swapped_days = {};

      _.chain(result.swapped_days)
       .mapRows(['schedule_date', 'end_time', 'begin_time', 'break_enabled', 'day_kind', 'break_begin_time', 'break_end_time', 'plan_time'])
       .each(swapped_day => {
        swapped_day.plan_time = bUtil.minutesToTime(swapped_day.plan_time);
        swapped_day.plan_time_view = pF(bUtil.timeToMinutes(swapped_day.plan_time) / 60);
        q.swapped_days[swapped_day.schedule_date] = swapped_day;
       });

      _.each(q.calendar_days, cday => {
        let date = moment(cday.calendar_date, 'DD.MM.YYYY');

        if (cday.calendar_day_kind == 'S') {
          if (date.year() == d.year) {
            cday.day = d.array_days[dayIndex(date)];
            q.calendar_months.push(date.month());
          } else {
            cday.day = q.swapped_days[cday.calendar_date];
          }

          let swapped_day;
          date = moment(cday.swapped_date, 'DD.MM.YYYY');

          if (date.year() == d.year) {
            swapped_day = d.array_days[dayIndex(date)];
            q.calendar_months.push(date.month());
          } else {
            swapped_day = q.swapped_days[cday.swapped_date];
          }

          cday.day.swapped_day = swapped_day;
          swapped_day.swapped_day = cday.day;
          cday.day.calendar_day_swap = cday;
          swapped_day.calendar_day_swap = cday;
        } else {
          cday.day = d.array_days[dayIndex(date)];
          q.calendar_months.push(date.month());
        }
      });

      q.calendar_months = _.unique(q.calendar_months);

      fixCalendarDays();
    }, page.alert);
  }

  function setCalendar(row) {
    if (!row) return;
    d.calendar_id = row.calendar_id;
    d.calendar_name = row.name;

    loadCalendarDays();
  }

  function addCalendar(value) {
    fi.add_calendar(null, setCalendar, { name: value });
  }

  function selectCalendar() {
    fi.select_calendar(null, setCalendar);
  }

  // prepare order no
  function prepareOrderNo() {
    var order_no = 1;
    var len = parseInt((d.schedule_days.length + 1) / 2);
    for (var i = 0; i < len; i ++) {
      d.schedule_days[i].order_no = order_no ++;
      if (i + len < d.schedule_days.length) d.schedule_days[i + len].order_no = order_no ++;
    }
  }

  // periodicity change
  function periodicityChange() {
    d.schedule_days = [];
    for (let i = 0; i < d.count_days; i++) {
      let day = angular.copy(q.pattern_day);
          day.break_enabled = 'Y';
          day.day_no = i + 1;
          day.day_kind = 'W';
      d.schedule_days.push(day);
    }
    prepareOrderNo();
  }

  // schedule kind change
  function patternKindChange() {
    if (d.pattern_kind == 'W') {
      d.schedule_days = [];
      d.count_days = q.week_days.length;
      _.each(q.week_days, function (week_day, i) {
      let day = angular.copy(q.pattern_day);
          day.break_enabled = 'Y';
          day.day_no = i + 1;
          day.day_kind = week_day.working ? 'W' : 'R';
        d.schedule_days.push(day);
      });
      prepareOrderNo();
    } else {
      periodicityChange();
    }
  }

  // calculating the count of working day and working hour in month
  function calcAvgDayAndHours(index) {
    let avg_days = 0;
    let avg_hours = 0;
    for (let j = 0; j < d.months[index].days.length; j++) {
      let day = d.months[index].days[j];
      if (day.day_kind == 'W' &&
          (day.calendar_day_kind == 'N' ||
          _.isUndefined(day.calendar_day_kind))) {
        avg_days ++;
        avg_hours += day.plan_time_view;
      } else if (day.calendar_day_kind == 'S' && day.day_kind == 'R') {
        avg_days ++;
        avg_hours += day.swapped_day.plan_time_view;
      }
    }
    d.months[index].avg_hours = pF(avg_hours);
    d.months[index].avg_days = avg_days;
  }

  // createng table of array list
  function createArrayInTable() {
    loadCalendarDays();
    let index = 0;
    d.months = [];

    for (let i = 0; i < 12; i++) {
      d.months[i] = {
        days: [],
        avg_days: 0,
        avg_hours: 0
      };
      let count = daysInMonth(i, d.year);
      for (let j = 0; j < count; j ++) {
        let day = d.array_days[index ++];
        let cday = day.cday;
        if (cday) fixDay(day, cday);
        else fixDayView(day);

        d.months[i].days.push(day);
      }
      calcAvgDayAndHours(i);
    }
  }

  // creating new array list
  function createArrayList() {
    let date = moment({ year: d.year, month: 0, day: 1 });
    q.days_count_year = dayCountInYear(d.year);
    d.array_days = [];

    for (let i = 0; i < q.days_count_year; i ++) {
      let day = angular.copy(q.pattern_day);
          day.break_enabled = 'Y';
          day.schedule_date = date.format('DD.MM.YYYY');
          day.day_kind = 'R';
          day.plan_time_view = pF(bUtil.timeToMinutes(q.pattern_day.plan_time) / 60);
          day.array_index = i;

      d.array_days[i] = day;
      date.add({ day: 1 });
    }
    createArrayInTable();
  }

  // filling days by result
  function fillDays(result) {
    let days = _.mapRows(result.days, ['schedule_date', 'end_time', 'begin_time', 'break_enabled', 'day_kind', 'break_begin_time', 'break_end_time',
                                       'plan_time', 'array_index', 'plan_time_view']),
        marks = _.chain(result.marks)
                 .mapRows(['schedule_date', 'begin_time', 'end_time'])
                 .groupBy('schedule_date')
                 .value(),
        weights = _.chain(result.weights)
                   .mapRows(['schedule_date', 'begin_time', 'end_time', 'weight'])
                   .groupBy('schedule_date')
                   .value();

    d.array_days = [];

    for (let i = 0; i < days.length; i++) {
      days[i].array_index = i;
      days[i].plan_time = bUtil.minutesToTime(days[i].plan_time);
      days[i].plan_time_view = pF(bUtil.timeToMinutes(days[i].plan_time) / 60);
      days[i].marks = marks[days[i].schedule_date] || [];
      days[i].weights = weights[days[i].schedule_date] || [];

      days[i].marks = _.map(days[i].marks, x => {
        return {
          begin_time: bUtil.minutesToTime(x.begin_time),
          end_time: bUtil.minutesToTime(x.end_time)
        };
      });

      days[i].weights = _.map(days[i].weights, x => {
        return {
          begin_time: bUtil.minutesToTime(x.begin_time),
          end_time: bUtil.minutesToTime(x.end_time),
          weight: x.weight,
        };
      });

      d.array_days[i] = days[i];
    }
    createArrayInTable();
  }

  // modal
  var modal = page.$content.find('form[name=modal]>.modal');

  function showModal() {
    $timeout(function() {
      modal.modal('show');
    });
  }

  function dayName(index) {
    return d.pattern_kind == 'W' ? q.week_days[index].name : t('$1 day')(index + 1);
  }

  function dayKindChange(day) {
    day = angular.copy(q.pattern_day);
    day.break_enabled = 'Y';
  }

  // calculating day
  function maxPlanMins(day) {
    let end_time = bUtil.timeToMinutes(day.end_time);
    let begin_time = bUtil.timeToMinutes(day.begin_time);
    let break_begin_time = bUtil.timeToMinutes(day.break_begin_time);
    let break_end_time = bUtil.timeToMinutes(day.break_end_time);
    let break_time = 0;
    let full_time = 0;

    if (day.break_enabled == 'Y' && break_begin_time != null && break_end_time != null) {
      if (break_end_time > break_begin_time) {
        break_time = break_end_time - break_begin_time;
      } else {
        break_time = (break_end_time + 1440) - break_begin_time;
      }
    }

    if (end_time > begin_time) {
      full_time = end_time - begin_time;
    } else {
      full_time = (end_time + 1440) - begin_time;
    }

    return full_time - break_time;
  }

  function calcDay(day) {
    day.plan_time = bUtil.minutesToTime(maxPlanMins(day));
  }

  // validate break time
  function isBreakTimeValid(day) {
    if (day.break_enabled == 'N' || !day.begin_time || !day.end_time) return true;

    let begin_time = bUtil.timeToMinutes(day.begin_time);
    let end_time = bUtil.timeToMinutes(day.end_time);
    let break_begin_time = bUtil.timeToMinutes(day.break_begin_time);
    let break_end_time = bUtil.timeToMinutes(day.break_end_time);

    end_time = begin_time < end_time ? end_time : end_time + 1440;
    break_end_time = break_begin_time < break_end_time ? break_end_time : break_end_time + 1440;

    if (break_begin_time >= break_end_time) return false;
    if (break_begin_time <= begin_time || break_end_time >= end_time) return false;

    return true;
  }

  // validate break time
  function isPlanTimeValid(day) {
    if (d.schedule_kind == q.sk_hourly || !day.begin_time || !day.end_time) return true;
    let max_plan_mins = maxPlanMins(day);
    let plan_mins = bUtil.timeToMinutes(day.plan_time);
    return plan_mins <= max_plan_mins;
  }

  // generating days by template in the model
  function generate(byTemplate) {
    if (page.valid(scope.modal) || byTemplate == 'Y') {
      if (d.all_days_equal == 'Y' && byTemplate != 'Y') {

        // if all days is equal then schedule days will be updated
        for (let i = 0; i < d.schedule_days.length; i++) {
          _.extend(d.schedule_days[i], angular.copy(q.pattern_day));
        }
      }

      let begin_date = moment(d.begin_date, 'DD.MM.YYYY'),
          end_date = moment(d.end_date, 'DD.MM.YYYY'),
          days_count = Math.floor(end_date.diff(begin_date) / oneDay) + 1,
          begin_week_day = begin_date.isoWeekday() - 1, // 0 - Mon, 6 - Sun
          date = moment(begin_date),
          index,
          day;

      for (let i = 0; i < days_count; i++) {
        if (d.pattern_kind == 'W') {
          index = (i + begin_week_day) % 7; // week day
        } else {
          index = i % d.count_days; // periodic day
        }

        let day = _.extend(d.array_days[dayIndex(date)], _.omit(d.schedule_days[index], ['day_no', 'order_no']));
        day.plan_time_view = pF(bUtil.timeToMinutes(day.plan_time) / 60);

        let cday = day.calendar_day_swap;
        if (cday) fixDay(cday.day, cday);
        else fixDayView(day);

        date.add({ day: 1 });
      }

      for (let i = begin_date.month(); i <= end_date.month(); i ++) {
        calcAvgDayAndHours(i);
      }

      $timeout(function () {
        modal.modal('hide');
      });
    }
  }

  // modal day
  var modalDay = page.$content.find('form[name=modalDay]>.modal');

  function showModalDay(day, month_index, day_index) {
    p.day = angular.copy(_.omit(day, 'swapped_day', 'calendar_day_swap'));
    if (day.swapped_day) {
       p.swapped_day = day.swapped_day;
       p.swapped_date_view = day.swapped_day.schedule_date.toMoment().format("D MMMM YYYY");
    }
    p.month_index = month_index;
    p.day_index = day_index;
    p.schedule_date_view = day.schedule_date.toMoment().format("D MMMM YYYY");

    $timeout(function () {
    page.untouch(scope.modalDay);
      modalDay.modal('show');
    });
  }

  function updateDay() {
    if (page.valid(scope.modalDay)) {
      let day = _.extend(d.array_days[p.day.array_index], p.day);
          day.plan_time_view = pF(bUtil.timeToMinutes(day.plan_time) / 60);

      // swapped day fix
      let cday = day.calendar_day_swap;
      if (cday) fixDay(cday.day, cday);
      else fixDayView(day);
      calcAvgDayAndHours(p.month_index);

      $timeout(function () {
        modalDay.modal('hide');
      });
    }
  }

  function getScheduleDays() {
    if (!d.year) return;
    page.post(':get_schedule_year', { year: d.year, schedule_id: d.schedule_id }).then(fillDays, page.alert);
  }

  // change year
  function fixYear(hard = false) {
    if (hard) {
      d.begin_date = "01.01." + d.year; // DD.MM.YYYY
      d.end_date   = "31.12." + d.year; // DD.MM.YYYY
    } else {
      d.begin_date = d.begin_date ? d.begin_date : "01.01." + d.year; // DD.MM.YYYY
      d.end_date = d.end_date ? d.end_date : "31.12." + d.year; // DD.MM.YYYY
    }
    q.year_begin = "01.01." + d.year;
    q.year_end = "31.12." + d.year;
    q.start_year = moment({ year: d.year });
    q.days_count_year = dayCountInYear(d.year);
  }

  function changeYear() {
    fixYear(true);

    if(d.schedule_id) {
      $timeout(function() {
        getScheduleDays();
      });
    } else {
      createArrayList();
    }
  }

  // advanced settings
  function checkHour(key, maxvalue) {
    var hour = `${key}_hour`;
      if (q[hour] > maxvalue)
          q[hour] = maxvalue;
  }

  function checkMinute(key, maxvalue) {
    var minute = `${key}_minute`,
        hour = `${key}_hour`;

    if (q[minute] > 59) {
       q[hour] = q[hour] * 1 + Math.floor(q[minute] / 60);
       q[minute] =  q[minute] % 60;
    }

    checkHour(key, maxvalue);

    if (q[hour] == 24) {
      q[minute] = 0;
    }
  }

  var rootToggle = page.$content.find('.root-toggle');

  // modal Limit Exceeded
  var modalLimitExceeded = page.$content.find('form[name=modalLimitExceeded]>.modal');

  function showModalLimitExceeded() {
    $timeout(function () {
      modalLimitExceeded.modal('show');
    });
  }

  function hideModalLimitExceeded() {
    $timeout(function () {
      modalLimitExceeded.modal('hide');
    });
  }

  // save
  function save() {
    if (page.valid(scope.form)) {
      if (d.use_calendar == 'N') {
        saveData();
        return;
      }

      var data = {
        'calendar_id': d.calendar_id,
        'year_begin': q.year_begin
      };

      data.days = [];
      _.each(d.array_days, (array_day, index) => {
          let day = _.pick(array_day, ['schedule_date', 'plan_time', 'day_kind', 'calendar_day_kind']);
          day.plan_time = bUtil.timeToMinutes(day.plan_time);

          if(d.array_days[index + 1]) {
            day.tomorrow_day_kind = d.array_days[index + 1].day_kind;
            day.tomorrow_calendar_day_kind = d.array_days[index + 1].calendar_day_kind;
          }

          data.days.push(day);
      });

      page.post(':check_by_calendar_limit', data).then(function(result) {
        p.data = {};

        if (!_.isUndefined(result.exceeded_days) && result.exceeded_days.length > 0) {
          p.data.type = 'D';
          p.data.title = t('daily plan time exceeded from calendar plan time')();

          // solutions for error
          p.data.solutions = [];
          p.data.solutions.push(t('turn of daily limit from calendar')());
          p.data.solutions.push(t('reduse daily plan time')());
          p.data.solutions.push(t('remove calendar')());

          p.data.exceeded_days = _.chain(result.exceeded_days)
                                  .mapRows(['schedule_date', 'plan_time', 'limit_time'])
                                  .map(x => {
                                    x.plan_time = bUtil.minutesToTime(x.plan_time);
                                    x.limit_time = bUtil.minutesToTime(x.limit_time);

                                    return x;
                                  })
                                  .value();


          showModalLimitExceeded();
        } else
        if (!_.isUndefined(result.exceeded_months) && result.exceeded_months.length) {
          p.data.type = 'M';
          p.data.title = 'monthly working day count is not the same with calendar day limit';

          // solutions for error
          p.data.solutions = [];
          p.data.solutions.push(t('turn of monthly limit from calendar')());
          p.data.solutions.push(t('make the same working day count with working day limit of calendar')());
          p.data.solutions.push(t('remove calendar')());

          p.data.exceeded_months = _.mapRows(result.exceeded_months, ['month', 'plan_days', 'limit_days']);

          showModalLimitExceeded();
        } else {
          saveData();
        }
      }, page.alert);
    }
  }

  function saveData() {
    d.input_acceptance = q.input_acceptance_hour * 60 + q.input_acceptance_minute * 1;
    d.output_acceptance = q.output_acceptance_hour * 60 + q.output_acceptance_minute * 1;

    if (d.schedule_kind != q.sk_hourly)
      d.track_duration = q.track_duration_hour * 60 + q.track_duration_minute * 1;

    var data = _.pick(d, 'schedule_id', 'schedule_kind',
                          'code', 'name', 'state', 'year',
                          'shift', 'input_acceptance', 'output_acceptance', 'track_duration',
                          'count_late', 'count_early', 'count_lack', 'count_free', 'use_weights',
                          'take_holidays', 'take_nonworking', 'take_additional_rest_days', 'advanced_setting',
                          'gps_turnout_enabled', 'gps_use_location', 'gps_max_interval');

    if (d.use_calendar == 'Y') data.calendar_id = d.calendar_id;

    if (d.advanced_setting == 'Y') {
      if (d.additional_time_type == q.additional_time_type_allowed) {
        if (d.count_late == 'Y') data.allowed_late_time = d.allowed_late_time.sign * d.allowed_late_time.amount;
        if (d.count_early == 'Y') data.allowed_early_time = d.allowed_early_time.sign * d.allowed_early_time.amount;
      } else {
        if (d.count_late == 'Y') data.begin_late_time = - d.begin_late_time;
        if (d.count_early == 'Y') data.end_early_time = d.end_early_time;
      }
    }

    data.shift = bUtil.timeToMinutes(data.shift);
    data.gps_max_interval = timeToSeconds(data.gps_max_interval);

    if (d.schedule_kind == q.sk_hourly)
      data.track_duration = bUtil.timeToMinutes(data.track_duration);

    var pattern = _.pick(d, 'pattern_kind', 'all_days_equal', 'count_days', 'begin_date', 'end_date');
        pattern.days = [];

    _.each(d.schedule_days, function(schedule_day) {
      let day = _.omit(schedule_day, 'order_no');

      day.begin_time = bUtil.timeToMinutes(day.begin_time);
      day.end_time = bUtil.timeToMinutes(day.end_time);
      day.break_begin_time = bUtil.timeToMinutes(day.break_begin_time);
      day.break_end_time = bUtil.timeToMinutes(day.break_end_time);
      day.plan_time = bUtil.timeToMinutes(day.plan_time);

      if (day.day_kind == 'R') day.plan_time = 0;

      if (d.use_marks == 'N' || day.day_kind == 'R') day.marks = [];
      if (d.use_weights == 'N' || day.day_kind == 'R') day.weights = [];

      day.marks = _.chain(day.marks)
                    .reject(x => { return !x.begin_time || !x.end_time })
                    .map(x => {
                      return {
                        begin_time: bUtil.timeToMinutes(x.begin_time),
                        end_time: bUtil.timeToMinutes(x.end_time),
                      };
                     })
                    .value();

      day.weights = _.chain(day.weights)
                     .reject(x => { return !x.begin_time || !x.end_time || !x.weight })
                     .map(x => {
                       return {
                         begin_time: bUtil.timeToMinutes(x.begin_time),
                         end_time: bUtil.timeToMinutes(x.end_time),
                         weight: x.weight,
                       };
                      })
                     .value();

      pattern.days.push(day);
    });

    data.pattern = pattern;
    data.days = [];
    data.marks = [];
    data.weights = [];

    _.each(d.array_days, function(array_day) {
      let day = _.pick(array_day, ['schedule_date', 'day_kind', 'begin_time', 'end_time', 'break_enabled',
                                    'break_begin_time', 'break_end_time', 'plan_time']);
      day.begin_time = bUtil.timeToMinutes(day.begin_time);
      day.end_time = bUtil.timeToMinutes(day.end_time);
      day.break_begin_time = bUtil.timeToMinutes(day.break_begin_time);
      day.break_end_time = bUtil.timeToMinutes(day.break_end_time);
      day.plan_time = bUtil.timeToMinutes(day.plan_time);

      let day_marks = {
        schedule_date: day.schedule_date,
        marks: []
      };

      if (d.use_marks == 'Y' && day.day_kind == 'W') {
        day_marks.marks = _.chain(array_day.marks)
                            .reject(x => { return !x.begin_time || !x.end_time })
                            .map(x => {
                              return {
                                begin_time: bUtil.timeToMinutes(x.begin_time),
                                end_time: bUtil.timeToMinutes(x.end_time),
                              };
                            })
                            .value();
      }

      let day_weights = {
        schedule_date: day.schedule_date,
        weights: []
      };

      if (d.use_weights == 'Y' && day.day_kind == 'W') {
        day_weights.weights = _.chain(array_day.weights)
                               .reject(x => { return !x.begin_time || !x.end_time || !x.weight })
                               .map(x => {
                                 return {
                                   begin_time: bUtil.timeToMinutes(x.begin_time),
                                   end_time: bUtil.timeToMinutes(x.end_time),
                                   weight: x.weight,
                                 };
                                })
                               .value();
      }

      data.days.push(day);
      data.marks.push(day_marks);
      data.weights.push(day_weights);
    });

    page.post(':save', data).then(page.close, page.alert);
  }

  function addMarkItem(marks) {
    marks.push({});
  }

  function removeMarkItem(marks, marks_key) {
    _.each(q.checked[marks_key].rows(), function(row) {
      let index = _.findIndex(marks, row);
      marks.splice(index, 1);
    });
    q.checked[marks_key] = {};
  }

  function onCheck(checked, key) {
    q.checked[key] = checked;
  }

  function addWeightItem(weights) {
    weights.push({});
  }

  function removeWeightItem(weights, weights_key) {
    _.each(q.weights_checked[weights_key].rows(), function(row) {
      let index = _.findIndex(weights, row);
      weights.splice(index, 1);
    });
    q.weights_checked[weights_key] = {};
  }

  function onWeightsCheck(checked, key) {
    q.weights_checked[key] = checked;
  }

  function changeAdvancedSetting(key, sign) {
    d[key].sign = sign;
  }

  fixYear();

  let default_track_duration = d.schedule_kind == q.sk_hourly ? 720 : 1440;
  let default_plan_time = d.schedule_kind == q.sk_hourly ? '12:00' : '08:00';

  q.pattern_day = d.template_id && d.all_days_equal ?
    _.find(d.schedule_days, x => {
      return x.day_kind == 'W';
    }) : {
    begin_time: '09:00',
    end_time: '18:00',
    break_enabled: 'Y',
    break_begin_time: '13:00',
    break_end_time: '14:00',
    plan_time: default_plan_time,
    marks: [],
    weights: []
  };

  // init reference months
  let date = moment(q.start_year);
  q.month_names = [];
  for (let i = 1; i <= 12; i ++) {
    let name = date.format('MMMM');
        name = name[0].toUpperCase() + name.slice(1);
    q.month_names.push(name);
    date.add({ month: 1 });
  }

  q.length_month = [];
  for (let i = 0; i < 31; i++) {
    q.length_month.push(i);
  }

  // init reference week days
  date.day(1);
  q.week_days = [];
  for (let i = 1; i <= 7; i ++) {
    let name = date.format('dddd');
        name = name[0].toUpperCase() + name.slice(1);
    q.week_days.push({ name, working: i < 6 });
    date.add({ day: 1 });
  }

  d.shift = d.shift || 0;
  d.input_acceptance = d.input_acceptance || 0;
  d.output_acceptance = d.output_acceptance || 0;
  d.track_duration = d.track_duration || default_track_duration;
  d.gps_max_interval = secondsToTime(d.gps_max_interval || 0);
  q.input_acceptance_hour = Math.floor(d.input_acceptance / 60);
  q.input_acceptance_minute = d.input_acceptance % 60;
  q.output_acceptance_hour = Math.floor(d.output_acceptance / 60);
  q.output_acceptance_minute = d.output_acceptance % 60;;
  q.track_duration_hour = Math.floor(d.track_duration / 60);
  q.track_duration_minute = d.track_duration % 60;
  q.checked = {};
  q.weights_checked = {};
  q.t_hour = t('hour')();
  q.t_minute = t('minute')();

  bUtil.minutesToTime(d, ['shift', 'input_acceptance', 'output_acceptance', 'track_duration']);

  if (d.schedule_id || d.template_id) {
    let default_pattern = true;
    prepareOrderNo();

    _.each(d.schedule_days, day => {
      bUtil.minutesToTime(day, ['begin_time', 'end_time', 'break_begin_time', 'break_end_time', 'plan_time']);

      day.marks = _.chain(day.marks)
                   .mapRows(['begin_time', 'end_time'])
                   .map(x => {
                     return {
                       begin_time: bUtil.minutesToTime(x.begin_time),
                       end_time: bUtil.minutesToTime(x.end_time)
                     };
                    })
                   .value();

      day.weights = _.chain(day.weights)
                     .mapRows(['begin_time', 'end_time', 'weight'])
                     .map(x => {
                       return {
                         begin_time: bUtil.minutesToTime(x.begin_time),
                         end_time: bUtil.minutesToTime(x.end_time),
                         weight: x.weight,
                       };
                      })
                     .value();

      if (d.template_id) default_pattern = false;

      if (d.all_days_equal && default_pattern && day.day_kind == 'W') {
        q.pattern_day = angular.copy(_.pick(day, _.keys(q.pattern_day)));
        default_pattern = false;
      }
    });

    d.count_days = d.schedule_days.length;

    if (d.template_id) {
      createArrayList();
      generate('Y');
    } else {
      fillDays({ days: d.days, marks: d.marks, weights: d.weights });
    }
  } else {
    patternKindChange();
    createArrayList();
  }

  page.$content.find('.scroll-table').hScroll();

  let t_title_custom_add    = t('schedule_title:add custom schedule')(),
      t_title_custom_edit   = t('schedule_title:edit custom schedule')(),
      t_title_hourly_add    = t('schedule_title:add hourly schedule')(),
      t_title_hourly_edit   = t('schedule_title:edit hourly schedule')(),
      t_title_flexible_add  = t('schedule_title:add flexible schedule')(),
      t_title_flexible_edit = t('schedule_title:edit flexible schedule')();

  let t_title = d.schedule_kind == q.sk_custom && !d.schedule_id   ? t_title_custom_add
              : d.schedule_kind == q.sk_custom && !!d.schedule_id  ? t_title_custom_edit
              : d.schedule_kind == q.sk_hourly && !d.schedule_id   ? t_title_hourly_add
              : d.schedule_kind == q.sk_hourly && !!d.schedule_id  ? t_title_hourly_edit
              : d.schedule_kind == q.sk_flexible && !d.schedule_id ? t_title_flexible_add
              : t_title_flexible_edit;

  page.title(t_title);

  _.each(['allowed_late_time', 'allowed_early_time', 'begin_late_time', 'end_early_time'], x => {
    model[x] = model[x] || 0;

    if (_.contains(['allowed_late_time', 'allowed_early_time'], x)) {
      d[x] = {
        sign: model[x] < 0 ? -1 : 1,
        amount: model[x] != 0 ? Math.abs(model[x]) : null
      }
    } else {
      d[x] = model[x] != 0 ? Math.abs(model[x]) : null;
    }
  });

  q.tMinute = t('minute')();
  q.tBefore = t('before')();
  q.tAfter = t('after')();
  q.tLateness = t('lateness')();
  q.tEarly = t('early output')();
  q.tAnd = t('and')();

  scope.d = d;
  scope.q = q;
  scope.p = p;

  scope.$watchGroup(['d.count_early', 'd.count_late'], function() {
    var setting_names = d.count_late == 'Y' ? q.tLateness : '';

    if (d.count_early == 'Y') {
      if (d.count_late == 'Y') setting_names += ' ' + q.tAnd + ' ';
      setting_names += q.tEarly;
    }

    q.t_advanced_setting_title = t("advanced setting for $1{setting_names}")(setting_names);
    if (d.count_early == 'N' && d.count_late == 'N') d.advanced_setting = 'N';
  });
});
</script>
<div class="b-toolbar">
  <button type="button" class="btn btn-primary" ng-click="save()" b-hotkey="save"><t>save</t></button>
  <button type="button" class="btn btn-default" ng-click="page.close()">{{ page.close.title }}</button>
</div>
<div class="b-content">
  <form name="form">
    <div class="card card-custom">
      <div class="card-body">
        <div class="form-row">
          <div class="col-sm-12">
            <div class="form-group">
              <label><t>name</t><r/></label>
              <input type="text" class="form-control" ng-model="d.name" b-maxlength="100" required/>
            </div>
            <div class="form-group row">
              <div class="col-sm-12">
                <label><t>year</t><r/></label>
                <input type="text" class="form-control" b-date-picker="YYYY" ng-change="changeYear()" ng-model="d.year" required/>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-sm-12">
                <label><t>code</t></label>
                <input type="text" class="form-control" ng-model="d.code" b-maxlength="50"/>
              </div>
            </div>
            <div class="form-group">
              <label><t>state</t></label><br/>
              <label class="switch">
                <input type="checkbox" ng-true-value="'A'" ng-false-value="'P'" ng-model="d.state"/>
                <span>
                  <t ng-if="d.state == 'A'">active</t>
                  <t ng-if="d.state == 'P'">passive</t>
                </span>
              </label>
            </div>
          </div>
          <div class="col-sm-12">
            <div class="form-group mt-6">
              <label class="checkbox">
                <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.use_calendar" ng-change="fixCalendarDays()"/>
                <span><t>use calendar</t></span>
              </label>
            </div>
            <div ng-if="d.use_calendar == 'Y'">
              <div class="form-group">
                <label><t>calendar</t><r/></label>
                <b-input name="calendars"
                         model="d.calendar_name | name"
                         model-key="d.calendar_id | calendar_id"
                         on-select="setCalendar(row)"
                         on-delete="setCalendar({})"
                         is-add="fi.add_calendar"
                         on-add="addCalendar(value)"
                         is-view="fi.select_calendar"
                         on-view="selectCalendar(row)"
                         required-key>
                  {{ row.name }}
                </b-input>
              </div>
              <div class="form-group">
                <label class="checkbox">
                  <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.take_holidays" ng-change="fixCalendarDays()"/>
                  <span><t>take holidays</t></span>
                </label>
              </div>
              <div class="form-group">
                <label class="checkbox" ng-if="d.use_calendar == 'Y'">
                  <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.take_nonworking" ng-change="fixCalendarDays()"/>
                  <span><t>take nonworking</t></span>
                </label>
              </div>
              <div class="form-group">
                <label class="checkbox">
                  <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.take_additional_rest_days" ng-change="fixCalendarDays()"/>
                  <span><t>take additional rest days</t></span>
                </label>
              </div>
            </div>
            <div class="form-row" ng-show="d.schedule_kind == q.sk_hourly">
              <div class="col-sm-8">
                <label><t>max worktime length {track_duration}</t></label>
                <input type="text" class="form-control" b-date-picker="HH:mm" ng-model="d.track_duration" ng-readonly="d.is_attached == 'Y'"/>
              </div>
            </div>
            <div class="form-row" ng-show="d.schedule_kind != q.sk_hourly">
              <div class="col-sm">
                <div class="form-row mb-4" ng-show="d.schedule_kind == q.sk_custom">
                  <div class="col-sm-6">
                    <label><t>shift time</t></label>
                    <input type="text" class="form-control" b-date-picker="HH:mm" ng-model="d.shift" ng-readonly="d.is_attached == 'Y'"/>
                  </div>
                </div>
                <div class="form-row mb-4" ng-show="d.schedule_kind == q.sk_custom">
                  <div class="col-sm-6">
                    <label><t>input acceptance</t></label>
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="{{ q.t_hour }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkHour('input_acceptance', 36)" ng-model="q.input_acceptance_hour" b-number scale="0" maxlength="2"/>
                      <div class="input-group-prepend input-group-append">
                        <span class="input-group-text">:</span>
                      </div>
                      <input type="text" class="form-control" placeholder="{{ q.t_minute }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkMinute('input_acceptance', 36)" ng-model="q.input_acceptance_minute" b-number scale="0" maxlength="2"/>
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <label><t>output acceptance</t>
                    </label>
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="{{ q.t_hour }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkHour('output_acceptance', 36)" ng-model="q.output_acceptance_hour" b-number scale="0" maxlength="2"/>
                      <div class="input-group-prepend input-group-append">
                        <span class="input-group-text">:</span>
                      </div>
                      <input type="text" class="form-control" placeholder="{{ q.t_minute }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkMinute('output_acceptance', 36)" ng-model="q.output_acceptance_minute" b-number scale="0" maxlength="2"/>
                    </div>
                  </div>
                </div>
                <div class="form-row mb-4" ng-show="d.schedule_kind == q.sk_custom">
                  <div class="col-sm-6">
                    <label><t>track duration</t>
                    </label>
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="{{ q.t_hour }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkHour('track_duration', 72)" ng-model="q.track_duration_hour" b-number scale="0" maxlength="2"/>
                      <div class="input-group-prepend input-group-append">
                        <span class="input-group-text">:</span>
                      </div>
                      <input type="text" class="form-control" placeholder="{{ q.t_minute }}" ng-readonly="d.is_attached == 'Y'" ng-blur="checkMinute('track_duration', 72)" ng-model="q.track_duration_minute" b-number scale="0" maxlength="2"/>
                    </div>
                  </div>
                </div>
                <div class="form-row mb-4">
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.use_marks"/>
                      <span><t>use marks</t></span>
                    </label>
                  </div>
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.use_weights"/>
                      <span><t>use weights</t></span>
                    </label>
                  </div>
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.count_free"/>
                      <span><t>count free</t></span>
                    </label>
                  </div>
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.count_late"/>
                      <span><t>count late</t></span>
                    </label>
                  </div>
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.count_early"/>
                      <span><t>count early</t></span>
                    </label>
                  </div>
                  <div class="col-sm-4">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.count_lack"/>
                      <span><t>count lack</t></span>
                    </label>
                  </div>
                </div>
                <div ng-show="d.schedule_kind == q.sk_custom">
                  <div class="form-row mb-4">
                    <div class="col-sm-4">
                      <label class="checkbox">
                        <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.gps_turnout_enabled"/>
                        <span><t>enable GPS turnout</t></span>
                      </label>
                    </div>
                  </div>
                  <div ng-if="d.gps_turnout_enabled == 'Y'">
                    <span class="form-text text-muted mb-1"><t>turnover time will be counted only if enforcing gps track exists</t></span>
                    <div class="form-group">
                      <label class="checkbox">
                        <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.gps_use_location"/>
                        <span><t>GPS use location</t></span>
                      </label>
                    </div>
                    <span class="form-text text-muted mb-1"><t>enforcing gps tracks will only be taken from employees location polygon</t></span>
                    <div class="form-row mb-4">
                      <div class="col-sm-6">
                        <label><t>gps max interval</t><r/></label>
                        <input type="text" class="form-control" b-date-picker="mm:ss" ng-model="d.gps_max_interval" ng-readonly="d.is_attached == 'Y'" required/>
                      </div>
                    </div>
                  </div>
                </div>
                <div ng-if="d.schedule_kind != q.sk_hourly">
                  <div class="form-group" ng-if="d.count_late == 'Y' || d.count_early == 'Y'">
                    <label class="checkbox">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-disabled="d.is_attached == 'Y'" ng-model="d.advanced_setting"/>
                      <span>{{ q.t_advanced_setting_title }}</span>
                    </label>
                  </div>
                  <div class="form-group mb-1" ng-if="d.advanced_setting == 'Y'">
                    <label><t>additional time type</t></label><br/>
                    <label class="radio mb-1">
                      <input type="radio" name="additional_time" value="A" ng-disabled="d.is_attached == 'Y'" ng-model="d.additional_time_type"/>
                      <span><t>allowed</t></span>
                    </label>
                    <label class="radio mb-1">
                      <input type="radio" name="additional_time" value="E" ng-disabled="d.is_attached == 'Y'" ng-model="d.additional_time_type"/>
                      <span><t>extra</t></span>
                    </label>
                  </div>
                  <div ng-if="d.advanced_setting == 'Y'">
                    <span class="form-text text-muted mb-1" ng-if="d.additional_time_type == q.additional_time_type_allowed"><t>by allowed time you can allow to be a few minutes late before/after the begin time or early output before/after the end time</t></span>
                    <span class="form-text text-muted mb-1" ng-if="d.additional_time_type == q.additional_time_type_extra"><t>by extra time you can set few minutes extra late time befor begin time or early time after end time</t></span>
                  </div>
                  <div class="form-group" ng-if="d.additional_time_type == q.additional_time_type_allowed && d.advanced_setting == 'Y'">
                    <div class="form-row">
                      <div class="col-sm-6" ng-if="d.count_late == 'Y'">
                        <label><t>allowed late time</t></label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary dropdown-toggle" ng-disabled="d.is_attached == 'Y'" style="width: 80px"
                              type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ d.allowed_late_time.sign == 1 ? q.tAfter : q.tBefore }}</button>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" ng-click="changeAdvancedSetting('allowed_late_time', 1)"
                                ng-show="d.allowed_late_time.sign == -1">{{ q.tAfter }}</a>
                              <a class="dropdown-item" ng-click="changeAdvancedSetting('allowed_late_time', -1)"
                              ng-show="d.allowed_late_time.sign == 1">{{ q.tBefore }}</a>
                            </div>
                          </div>
                          <input type="text" class="form-control" ng-disabled="d.is_attached == 'Y'" placeholder="{{ q.tMinute }}" ng-model="d.allowed_late_time.amount" b-number scale="0" maxlength="3" />
                        </div>
                      </div>
                      <div class="col-sm-6" ng-if="d.count_early == 'Y'">
                        <label><t>allowed early time</t></label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <button class="btn btn-outline-secondary dropdown-toggle" ng-disabled="d.is_attached == 'Y'" style="width: 80px"
                              type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ d.allowed_early_time.sign == 1 ? q.tAfter : q.tBefore }}</button>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" ng-click="changeAdvancedSetting('allowed_early_time', 1)"
                                ng-show="d.allowed_early_time.sign == -1">{{ q.tAfter }}</a>
                              <a class="dropdown-item" ng-click="changeAdvancedSetting('allowed_early_time', -1)"
                              ng-show="d.allowed_early_time.sign == 1">{{ q.tBefore }}</a>
                            </div>
                          </div>
                          <input type="text" class="form-control" ng-disabled="d.is_attached == 'Y'" placeholder="{{ q.tMinute }}" ng-model="d.allowed_early_time.amount" b-number scale="0" maxlength="3" />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group" ng-if="d.additional_time_type == q.additional_time_type_extra && d.advanced_setting == 'Y'">
                    <div class="form-row">
                      <div class="col-sm-6" ng-if="d.count_late == 'Y'">
                        <label><t>extra late time</t></label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="form-view text-center" style="width: 80px">{{ q.tBefore }}</span>
                          </div>
                          <input type="text" class="form-control" ng-disabled="d.is_attached == 'Y'" placeholder="{{ q.tMinute }}" ng-model="d.begin_late_time" b-number scale="0" maxlength="3" />
                        </div>
                      </div>
                      <div class="col-sm-6" ng-if="d.count_early == 'Y'">
                        <label><t>extra early time</t></label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="form-view text-center" style="width: 80px">{{ q.tAfter }}</span>
                          </div>
                          <input type="text" class="form-control" ng-disabled="d.is_attached == 'Y'" placeholder="{{ q.tMinute }}" ng-model="d.end_early_time" b-number scale="0" maxlength="3" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-default" ng-click="showModal()"><t>fill</t></button>
        </div>
        <div class="scroll-table">
          <table class="table table-striped table-bordered">
            <tr>
              <td><t>month</t></td>
              <td><t>avg days</t></td>
              <td><t>avg hours</t></td>
              <td class="text-center" ng-repeat="i in q.length_month">{{ i + 1 }}</td>
            </tr>
            <tr ng-init="month_index = $index" ng-repeat="month in d.months">
              <td>{{ q.month_names[$index] }}</td>
              <td>{{ month.avg_days }}</td>
              <td>{{ month.avg_hours }}</td>
              <td class="text-center" ng-repeat="day in month.days track by $index" ng-click="showModalDay(day, month_index, $index)" style="cursor: pointer;"
                  ng-style="{ 'background-color': day.day_color }">
                <span>{{ day.day_view }}</span>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </form>
  <form name="modal">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" style="max-width: 1000px;">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"><t>schedule settings</t></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="col-sm-24">
              <div class="form-group row">
                <div class="col-sm-12">
                  <div class="form-group">
                    <label><t>pattern kind</t></label><br/>
                    <label class="radio">
                      <input type="radio" name="pattern_kind" value="W" ng-model="d.pattern_kind" ng-change="patternKindChange()"/>
                      <span><t>weekly</t></span>
                    </label>
                    <label class="radio">
                      <input type="radio" name="pattern_kind" value="P" ng-model="d.pattern_kind" ng-change="patternKindChange()"/>
                      <span><t>periodic</t></span>
                    </label>
                  </div>
                  <div class="form-group row">
                    <div class="col-sm-12">
                      <label><t>begin date</t><r/></label>
                      <input type="text" class="form-control" b-date-picker="DD.MM.YYYY" min-date="q.year_begin" ng-model="d.begin_date" required/>
                    </div>
                    <div class="col-sm-12">
                      <label><t>end date</t><r/></label>
                      <input type="text" class="form-control" b-date-picker="DD.MM.YYYY" max-date="q.year_end" ng-model="d.end_date" required/>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>&nbsp;</label><br/>
                    <label class="switch">
                      <input type="checkbox" ng-true-value="'Y'" ng-false-value="'N'" ng-model="d.all_days_equal"/>
                      <span><t>all days equal</t></span>
                    </label>
                  </div>
                  <div class="form-group" ng-if="d.all_days_equal == 'N' && d.use_weights == 'Y'">
                    <span class="text-muted"><t>time not covered by weights will not be calculated</t></span>
                  </div>
                </div>
                <div class="col-sm-6" ng-if="d.pattern_kind == 'P'">
                  <div class="form-group">
                    <label><t>count_days</t><r/></label>
                    <input type="text" class="form-control" min="1" ng-model="d.count_days" ng-change="periodicityChange()" b-number scale="0" required/>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-24">
              <div ng-repeat="day in d.schedule_days" ng-if="d.all_days_equal == 'N'">
                <div class="form-group">
                  <div class="form-row">
                    <div class="col-sm-6" style="display: flex; align-items: center;">
                      <label>&nbsp;</label>
                      <label class="checkbox" ng-class="{ 'font-weight-bolder': day.day_kind == 'W' }">
                        <input type="checkbox" ng-model="day.day_kind" ng-true-value="'W'" ng-false-value="'R'" ng-change="dayKindChange(day)"/>&emsp;<span>{{ dayName($index) }}</span>
                      </label>
                    </div>
                    <div class="col-sm-8">
                      <div class="form-row">
                        <div class="col-sm-12" ng-if="d.schedule_kind != q.sk_hourly">
                          <div class="form-group">
                            <label><t>begin time</t><r/></label>
                            <input type="text" class="form-control" ng-change="calcDay(d.schedule_days[$index])" ng-model="day.begin_time" b-date-picker="HH:mm" ng-disabled="day.day_kind == 'R'" ng-required="day.day_kind == 'W'"/>
                          </div>
                        </div>
                        <div class="col-sm-12" ng-if="d.schedule_kind != q.sk_hourly">
                          <label><t>end time</t><r/></label>
                          <input type="text" class="form-control" ng-change="calcDay(d.schedule_days[$index])" ng-model="day.end_time" b-date-picker="HH:mm" ng-disabled="day.day_kind == 'R'" ng-required="day.day_kind == 'W'"/>
                        </div>
                        <div class="col-sm-12">
                          <label><t>plan time</t><r/></label>
                          <input type="text" class="form-control" ng-model="day.plan_time" b-validate="{ s: day.day_kind == 'R' || isPlanTimeValid(day) }" b-date-picker="HH:mm" ng-disabled="day.day_kind == 'R'" ng-required="day.day_kind == 'W'"/>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-2" ng-if="d.schedule_kind != q.sk_hourly">
                      <label>&nbsp;</label>
                      <label class="checkbox">
                        <input type="checkbox" ng-model="day.break_enabled" ng-true-value="'Y'" ng-false-value="'N'" ng-change="calcDay(d.schedule_days[$index])" ng-disabled="day.day_kind == 'R'"/>
                        <span><t>break enable</t></span>
                      </label>
                    </div>
                    <div class="col-sm-8" ng-if="d.schedule_kind != q.sk_hourly && day.break_enabled == 'Y'">
                      <div class="form-row">
                        <div class="col-12">
                          <label><t>break begin</t><r/></label>
                          <input type="text" class="form-control" ng-change="calcDay(d.schedule_days[$index])" ng-model="day.break_begin_time" b-validate="{ s: day.day_kind == 'R' || isBreakTimeValid(day) }" b-date-picker="HH:mm"
                                ng-disabled="day.day_kind == 'R' || day.break_enabled == 'N'" ng-required="day.day_kind == 'W' && day.break_enabled == 'Y'"/>
                        </div>
                        <div class="col-12">
                          <label><t>break end</t><r/></label>
                          <input type="text" class="form-control" ng-change="calcDay(d.schedule_days[$index])" ng-model="day.break_end_time" b-validate="{ s: day.day_kind == 'R' || isBreakTimeValid(day) }" b-date-picker="HH:mm"
                                ng-disabled="day.day_kind == 'R' || day.break_enabled == 'N'" ng-required="day.day_kind == 'W' && day.break_enabled == 'Y'"/>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-5">
                    <div class="text-danger" ng-hide="!day || day.day_kind != 'W' || isBreakTimeValid(day)"><t>invalid break time</t></div>
                    <div class="text-danger" ng-hide="!day || day.day_kind != 'W' || isPlanTimeValid(day)"><t>invalid plan time</t></div>
                  </div>
                  <div ng-if="d.schedule_kind != q.sk_hourly && d.use_marks == 'Y' && day.day_kind == 'W'">
                    <div ng-if="d.use_weights == 'Y'" class="separator separator-solid my-6"></div>
                    <h5 ng-if="d.use_weights == 'Y'" class="text-primary mb-4">
                      <t>marks</t>
                    </h5>
                    <div class="form-row">
                      <div class="col-sm-14 mb-2">
                        <button type="button" class="btn btn-default" ng-click="addMarkItem(day.marks)"><t>add</t></button>
                        <button type="button" class="btn btn-danger" ng-click="removeMarkItem(day.marks, day.day_no)" ng-show="q.checked[day.day_no].has">
                          <t p1="q.checked[day.day_no].size">delete $1</t>
                        </button>
                      </div>
                      <div class="col-sm-10 mb-2" ng-if="day.marks.length > 50">
                        <b-pg-controller name="{{ 'marks' + $index }}"/>
                      </div>
                    </div>
                    <b-pg-grid name="{{ 'marks' + $index }}" local-data="day.marks" iterator="item" on-check="onCheck(checked, day.day_no)" limit="50">
                      <b-pg-header name="begin_time"><t>mark begin time</t></b-pg-header>
                      <b-pg-header name="end_time"><t>mark end time</t></b-pg-header>
                      <b-pg-row>
                        <b-pg-col name="begin_time" size="11">
                          <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                        </b-pg-col>
                        <b-pg-col name="end_time" size="11">
                          <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                        </b-pg-col>
                      </b-pg-row>
                    </b-pg-grid>
                  </div>
                  <div ng-if="d.schedule_kind != q.sk_hourly && d.use_weights == 'Y' && day.day_kind == 'W'">
                    <div class="separator separator-solid my-6"></div>
                    <h5 ng-if="d.use_marks == 'Y'" class="text-primary mb-4">
                      <t>weights</t>
                    </h5>
                    <div class="form-row">
                      <div class="col-sm-14 mb-2">
                        <button type="button" class="btn btn-default" ng-click="addWeightItem(day.weights)"><t>add</t></button>
                        <button type="button" class="btn btn-danger" ng-click="removeWeightItem(day.weights, day.day_no)" ng-show="q.weights_checked[day.day_no].has">
                          <t p1="q.weights_checked[day.day_no].size">delete $1</t>
                        </button>
                      </div>
                      <div class="col-sm-10 mb-2" ng-if="day.weights.length > 50">
                        <b-pg-controller name="{{ 'weights' + $index }}"/>
                      </div>
                    </div>
                    <b-pg-grid name="{{ 'weights' + $index }}" local-data="day.weights" iterator="item" on-check="onWeightsCheck(checked, day.day_no)" limit="50">
                      <b-pg-header name="begin_time"><t>weight begin time</t></b-pg-header>
                      <b-pg-header name="end_time"><t>weight end time</t></b-pg-header>
                      <b-pg-header name="weight"><t>weight</t></b-pg-header>
                      <b-pg-row>
                        <b-pg-col name="begin_time" size="7">
                          <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                        </b-pg-col>
                        <b-pg-col name="end_time" size="7">
                          <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                        </b-pg-col>
                        <b-pg-col name="weight" size="7">
                          <input type="text" class="form-control" ng-model="item.weight" required b-number scale="0"/>
                        </b-pg-col>
                      </b-pg-row>
                    </b-pg-grid>
                  </div>
                </div>
                <div class="separator separator-dashed my-6" style="border-width: 2px;" ng-if="!$last"></div>
              </div>
              <div class="form-group" ng-if="d.all_days_equal == 'Y'">
                <div class="form-row">
                  <div class="col-sm-12 ">
                    <h5 class="font-weight-bolder"><t>schedule days</t></h5><br>
                    <div class="form-group row">
                      <div class="col-sm-12 mb-4" ng-repeat="day in d.schedule_days | orderBy: 'order_no'" style="display: flex; align-items: center;">
                        <label class="checkbox" ng-class="{ 'font-weight-bolder': day.day_kind == 'W' }">
                          <input type="checkbox" ng-model="day.day_kind" ng-true-value="'W'" ng-false-value="'R'" ng-change="dayKindChange(day)"/>&emsp;<span>{{ dayName(day.day_no - 1) }}</span>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12">
                    <h5 class="font-weight-bolder"><t>schedule time</t></h5>
                    <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly">
                      <div class="col-sm-12 mb-sm-0 mb-4">
                        <label><t>begin time</t><r/></label>
                        <input type="text" class="form-control" ng-change="calcDay(q.pattern_day)" ng-model="q.pattern_day.begin_time" b-date-picker="HH:mm" required/>
                      </div>
                      <div class="col-sm-12">
                        <label><t>end time</t><r/></label>
                        <input type="text" class="form-control" ng-change="calcDay(q.pattern_day)" ng-model="q.pattern_day.end_time" b-date-picker="HH:mm" required/>
                      </div>
                    </div>
                    <div class="form-group" ng-if="d.schedule_kind != q.sk_hourly">
                      <label class="switch">
                        <input type="checkbox" ng-model="q.pattern_day.break_enabled" ng-change="calcDay(q.pattern_day)" ng-true-value="'Y'" ng-false-value="'N'"/>
                        <span><t>break enable</t></span>
                      </label>
                    </div>
                    <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly && q.pattern_day.break_enabled == 'Y'">
                      <div class="col-sm-12 mb-sm-0 mb-4">
                        <label><t>break begin</t><r/></label>
                        <input type="text" class="form-control" ng-change="calcDay(q.pattern_day)" ng-model="q.pattern_day.break_begin_time" b-validate="{ s: isBreakTimeValid(q.pattern_day) }" b-date-picker="HH:mm" ng-required="q.pattern_day.break_enabled == 'Y'"/>
                      </div>
                      <div class="col-sm-12">
                        <label><t>break end</t><r/> </label>
                        <input type="text" class="form-control" ng-change="calcDay(q.pattern_day)" ng-model="q.pattern_day.break_end_time" b-validate="{ s: isBreakTimeValid(q.pattern_day) }" b-date-picker="HH:mm" ng-required="q.pattern_day.break_enabled == 'Y'"/>
                      </div>
                    </div>
                    <div class="form-row mb-4">
                      <div class="col-sm-12">
                        <label><t>plan time</t></label>
                        <input type="text" class="form-control" ng-model="q.pattern_day.plan_time" b-validate="{ s: isPlanTimeValid(q.pattern_day) }" b-date-picker="HH:mm"/>
                      </div>
                    </div>
                  </div>
                </div>
                <div ng-if="d.schedule_kind != q.sk_hourly && d.use_marks == 'Y'">
                  <div class="separator separator-solid my-6"></div>
                  <h5 ng-if="d.use_weights == 'Y'" class="text-primary mb-4">
                    <t>marks</t>
                  </h5>
                  <div class="form-row">
                    <div class="col-sm-14 mb-2">
                      <button type="button" class="btn btn-default" ng-click="addMarkItem(q.pattern_day.marks)"><t>add</t></button>
                      <button type="button" class="btn btn-danger" ng-click="removeMarkItem(q.pattern_day.marks, 'pattern_marks')" ng-show="q.checked['pattern_marks'].has">
                        <t p1="q.checked['pattern_marks'].size">delete $1</t>
                      </button>
                    </div>
                    <div class="col-sm-10 mb-2" ng-if="q.pattern_day.marks.length > 50">
                      <b-pg-controller name="pattern_marks"/>
                    </div>
                  </div>
                  <b-pg-grid name="pattern_marks" local-data="q.pattern_day.marks" iterator="item" on-check="onCheck(checked, 'pattern_marks')" limit="50">
                    <b-pg-row>
                      <b-pg-col name="begin_time" size="11">
                        <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="end_time" size="11">
                        <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                    </b-pg-row>
                  </b-pg-grid>
                </div>
                <div ng-if="d.schedule_kind != q.sk_hourly && d.use_weights == 'Y'">
                  <div class="separator separator-solid my-6"></div>
                  <h5 ng-if="d.use_marks == 'Y'" class="text-primary mb-4">
                    <t>weights</t>
                  </h5>
                  <div class="form-row">
                    <div class="col-sm-14 mb-2">
                      <button type="button" class="btn btn-default" ng-click="addWeightItem(q.pattern_day.weights)"><t>add</t></button>
                      <button type="button" class="btn btn-danger" ng-click="removeWeightItem(q.pattern_day.weights, 'pattern_weights')" ng-show="q.weights_checked['pattern_weights'].has">
                        <t p1="q.weights_checked['pattern_weights'].size">delete $1</t>
                      </button>
                    </div>
                    <div class="col-sm-10 mb-2" ng-if="q.pattern_day.weights.length > 50">
                      <b-pg-controller name="pattern_weights"/>
                    </div>
                  </div>
                  <div class="form-group">
                    <span class="text-muted"><t>time not covered by weights will not be calculated</t></span>
                  </div>
                  <b-pg-grid name="pattern_weights" local-data="q.pattern_day.weights" iterator="item" on-check="onWeightsCheck(checked, 'pattern_weights')" limit="50">
                    <b-pg-header name="begin_time"><t>weight begin time</t></b-pg-header>
                    <b-pg-header name="end_time"><t>weight end time</t></b-pg-header>
                    <b-pg-header name="weight"><t>weight</t></b-pg-header>
                    <b-pg-row>
                      <b-pg-col name="begin_time" size="7">
                        <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="end_time" size="7">
                        <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="weight" size="7">
                        <input type="text" class="form-control" ng-model="item.weight" required b-number scale="0"/>
                      </b-pg-col>
                    </b-pg-row>
                  </b-pg-grid>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <span>
              <div class="text-danger" ng-hide="d.all_days_equal == 'N' || !q.pattern_day || isBreakTimeValid(q.pattern_day)"><t>invalid break time</t></div>
              <div class="text-danger" ng-hide="d.all_days_equal == 'N' || !q.pattern_day || isPlanTimeValid(q.pattern_day)"><t>invalid plan time</t></div>
            </span>
            <span>
              <button type="button" class="btn btn-primary" ng-click="generate('N')"><t>generate</t></button>
              <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
            </span>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modalDay">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{{ p.schedule_date_view }}</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="col-sm-24">
              <div class="form-row mb-2">
                <div class="col-sm-12">
                  <label class="radio">
                    <input type="radio" name="day_kind" value="W" ng-model="p.day.day_kind"/>
                    <span><t>working</t></span>
                  </label>
                </div>
                <div class="col-sm-12">
                  <label class="radio">
                    <input type="radio" name="day_kind" value="R" ng-model="p.day.day_kind"/>
                    <span><t>rest</t></span>
                  </label>
                </div>
              </div>
              <div ng-if="p.day.day_kind == 'W'">
                <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly">
                  <div class="col-sm-12 mb-sm-0 mb-4">
                    <label><t>begin time</t><r/></label>
                    <input type="text" class="form-control" ng-change="calcDay(p.day)" ng-model="p.day.begin_time" b-date-picker="HH:mm" required/>
                  </div>
                  <div class="col-sm-12">
                    <label><t>end time</t><r/></label>
                    <input type="text" class="form-control" ng-change="calcDay(p.day)" ng-model="p.day.end_time" b-date-picker="HH:mm" required/>
                  </div>
                </div>
                <div class="form-group" ng-if="d.schedule_kind != q.sk_hourly">
                  <label class="switch">
                    <input type="checkbox" ng-model="p.day.break_enabled" ng-change="calcDay(p.day)" ng-true-value="'Y'" ng-false-value="'N'"/>
                    <span><t>break enable</t></span>
                  </label>
                </div>
                <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly && p.day.break_enabled == 'Y'">
                  <div class="col-sm-12 mb-sm-0 mb-4">
                    <label><t>break begin</t><r/></label>
                    <input type="text" class="form-control" ng-change="calcDay(p.day)" ng-model="p.day.break_begin_time" b-validate="{ s: isBreakTimeValid(p.day) }" b-date-picker="HH:mm" ng-required="p.day.break_enabled == 'Y'"/>
                  </div>
                  <div class="col-sm-12">
                    <label><t>break end</t><r/></label>
                    <input type="text" class="form-control" ng-change="calcDay(p.day)" ng-model="p.day.break_end_time" b-validate="{ s: isBreakTimeValid(p.day) }" b-date-picker="HH:mm" ng-required="p.day.break_enabled == 'Y'"/>
                  </div>
                </div>
                <div class="form-row mb-4">
                  <div class="col-sm-12">
                    <label><t>plan time</t><r/></label>
                    <input type="text" class="form-control" ng-model="p.day.plan_time" b-validate="{ s: isPlanTimeValid(p.day) }" b-date-picker="HH:mm" required/>
                  </div>
                </div>
                <div ng-if="d.schedule_kind != q.sk_hourly && d.use_marks == 'Y'">
                  <div class="separator separator-solid my-6"></div>
                  <h5 ng-if="d.use_weights == 'Y'" class="text-primary mb-4">
                    <t>marks</t>
                  </h5>
                  <div class="form-row">
                    <div class="col-sm-10 mb-2">
                      <button type="button" class="btn btn-default" ng-click="addMarkItem(p.day.marks)"><t>add</t></button>
                      <button type="button" class="btn btn-danger" ng-click="removeMarkItem(p.day.marks, 'day_marks')" ng-show="q.checked['day_marks'].has">
                        <t p1="q.checked['day_marks'].size">delete $1</t>
                      </button>
                    </div>
                    <div class="col-sm mb-2" ng-if="p.day.marks.length > 50">
                      <b-pg-controller name="day_marks"/>
                    </div>
                  </div>
                  <b-pg-grid name="day_marks" local-data="p.day.marks" min-width="auto" iterator="item" on-check="onCheck(checked, 'day_marks')" limit="50">
                    <b-pg-row>
                      <b-pg-col name="begin_time" size="11">
                        <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="end_time" size="11">
                        <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                    </b-pg-row>
                  </b-pg-grid>
                </div>
                <div ng-if="d.schedule_kind != q.sk_hourly && d.use_weights == 'Y'">
                  <div class="separator separator-solid my-6"></div>
                  <h5 ng-if="d.use_marks == 'Y'" class="text-primary mb-4"><t>weights</t></h5>
                  <div class="form-row">
                    <div class="col-sm-14 mb-2">
                      <button type="button" class="btn btn-default" ng-click="addWeightItem(p.day.weights)"><t>add</t></button>
                      <button type="button" class="btn btn-danger" ng-click="removeWeightItem(p.day.weights, 'day_weights')" ng-show="q.weights_checked['day_weights'].has">
                        <t p1="q.weights_checked['day_weights'].size">delete $1</t>
                      </button>
                    </div>
                    <div class="col-sm-10 mb-2" ng-if="p.day.weights.length > 50">
                      <b-pg-controller name="day_weights"/>
                    </div>
                  </div>
                  <div class="form-group">
                    <span class="text-muted"><t>time not covered by weights will not be calculated</t></span>
                  </div>
                  <b-pg-grid name="day_weights" local-data="p.day.weights" iterator="item" on-check="onWeightsCheck(checked, 'day_weights')" limit="50" min-width="auto">
                    <b-pg-header name="begin_time"><t>weight begin time</t></b-pg-header>
                    <b-pg-header name="end_time"><t>weight end time</t></b-pg-header>
                    <b-pg-header name="weight"><t>weight</t></b-pg-header>
                    <b-pg-row>
                      <b-pg-col name="begin_time" size="7">
                        <input type="text" class="form-control" ng-model="item.begin_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="end_time" size="7">
                        <input type="text" class="form-control" ng-model="item.end_time" b-date-picker="HH:mm" required/>
                      </b-pg-col>
                      <b-pg-col name="weight" size="7">
                        <input type="text" class="form-control" ng-model="item.weight" required b-number scale="0"/>
                      </b-pg-col>
                    </b-pg-row>
                  </b-pg-grid>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-header" ng-if="p.day.calendar_day_kind == 'S'">
            <h4 class="modal-title">{{ p.swapped_date_view }}</h4>
          </div>
          <div class="modal-body" ng-if="p.day.calendar_day_kind == 'S'">
            <div class="col-sm-24">
              <div class="form-row mb-2">
                <div class="col-sm-12">
                  <label class="radio">
                    <input type="radio" name="swapped_day_kind" value="W" ng-model="p.swapped_day.day_kind" disabled/>
                    <span><t>working</t></span>
                  </label>
                </div>
                <div class="col-sm-12">
                  <label class="radio">
                    <input type="radio" name="swapped_day_kind" value="R" ng-model="p.swapped_day.day_kind" disabled/>
                    <span><t>rest</t></span>
                  </label>
                </div>
              </div>
              <div ng-if="p.swapped_day.day_kind == 'W'">
                <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly">
                  <div class="col-sm-12 mb-sm-0 mb-4">
                    <label><t>begin time</t></label>
                    <span type="text" class="form-view">{{ p.swapped_day.begin_time }}</span>
                  </div>
                  <div class="col-sm-12">
                    <label><t>end time</t></label>
                    <span type="text" class="form-view">{{ p.swapped_day.end_time }}</span>
                  </div>
                </div>
                <div class="form-group" ng-if="d.schedule_kind != q.sk_hourly">
                  <label class="switch">
                    <input type="checkbox" ng-model="p.swapped_day.break_enabled" ng-change="calcDay(p.day)" ng-true-value="'Y'" ng-false-value="'N'" disabled/>
                    <span><t>break enable</t></span>
                  </label>
                </div>
                <div class="form-row mb-4" ng-if="d.schedule_kind != q.sk_hourly && p.swapped_day.break_enabled == 'Y'">
                  <div class="col-sm-12 mb-sm-0 mb-4">
                    <label><t>break begin</t></label>
                    <span type="text" class="form-view">{{ p.swapped_day.break_begin_time }}</span>
                  </div>
                  <div class="col-sm-12">
                    <label><t>break end</t></label>
                    <span type="text" class="form-view">{{ p.swapped_day.break_end_time }}</span>
                  </div>
                </div>
                <div class="form-row mb-4">
                  <div class="col-sm-12">
                    <label><t>plan time</t></label>
                    <span type="text" class="form-view">{{ p.swapped_day.plan_time }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-body" ng-if="p.day.calendar_day_kind || (p.day.calendar_day_kind == 'H' && d.take_holidays == 'Y' || p.day.calendar_day_kind == 'N' && d.take_nonworking == 'Y')">
            <label style="text-align: left;" ng-style="{ 'color': p.day.text_color }"><h4>{{ p.day.day_name }}</h4></label>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <span>
              <div class="text-danger" ng-hide="!p.day || p.day.day_kind != 'W' || isBreakTimeValid(p.day)"><t>invalid break time</t></div>
              <div class="text-danger" ng-hide="!p.day || p.day.day_kind != 'W' || isPlanTimeValid(p.day)"><t>invalid plan time</t></div>
            </span>
            <span>
              <button type="button" class="btn btn-primary" ng-click="updateDay()"><t>edit</t></button>
              <button type="button" class="btn btn-default" data-dismiss="modal"><t>close</t></button>
            </span>
          </div>
        </div>
      </div>
    </div>
  </form>
  <form name="modalLimitExceeded">
    <div class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="journal">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">
              <h4 class="mb-0 d-flex align-items-center">
                <i class="fa fa-exclamation-circle fa-2x text-danger my-n4 mr-4 opacity-50 h1 font-weight-bolder"></i>
                <div>{{ p.data.title }}</div>
              </h4>
            </div>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="col-sm-12">
                <div class="form-group">
                  <h3><t>solutions</t></h3>
                  <div class="separator separator-solid mt-2 mb-2"></div>
                  <ul ng-repeat="message in p.data.solutions">
                    <li>{{ message }}</li>
                  </ul>
                </div>
              </div>
            </div>
            <div ng-if="p.data.type == 'D'">
              <div class="row" ng-if="p.data.exceeded_days.length > 10">
                <div class="offset-sm-8 col-sm-16 mb-2">
                  <b-pg-controller name="exceededDays"/>
                </div>
              </div>
              <b-pg-grid name="exceededDays" local-data="p.data.exceeded_days" min-width="500" iterator="item" max-limit="1000">
                <b-pg-row>
                  <b-pg-col name="schedule_date" size="12"/>
                  <b-pg-col name="plan_time" size="6"/>
                  <b-pg-col name="limit_time" size="6"/>
                </b-pg-row>
              </b-pg-grid>
            </div>
            <div ng-if="p.data.type == 'M'">
              <b-pg-grid name="exceededMonths" local-data="p.data.exceeded_months" min-width="500" iterator="item" limit="12" max-limit="1000">
                <b-pg-row>
                  <b-pg-col name="month" size="12"/>
                  <b-pg-col name="plan_days" size="6"/>
                  <b-pg-col name="limit_days" size="6"/>
                </b-pg-row>
              </b-pg-grid>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>